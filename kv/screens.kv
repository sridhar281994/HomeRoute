<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: 'vertical'
            size_hint: None, None
            # Responsive width/height
            width: min(root.width * 0.9, dp(600))
            height: min(self.minimum_height, root.height * 0.85)
            spacing: dp(20)
            padding: dp(20)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Find Your Perfect Match"
                font_size: min(root.width * 0.08, sp(28))
                color: 1, 1, 1, 1
                size_hint_y: None
                halign: "center"
                valign: "middle"
                text_size: (self.width, None)
                height: self.texture_size[1] + dp(20)

            Button:
                text: "Login"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.5, 1, 1)
                on_release: root.manager.current = 'login'

            Button:
                text: "Register"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.3, 0.8, 0.3, 1)
                on_release: root.manager.current = 'register'

        Label:
            text: "Â© 2025 SRTech Games"
            font_size: min(root.width * 0.035, sp(14))
            color: 1, 1, 1, 0.7
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5, "y": 0.05}

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False
            bar_width: 0

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                # ScrollView controls viewport size/pos when size_hint_x is set.
                # Using explicit width without disabling size_hint_x can cause repeated relayout loops.
                x: (root.width - self.width) / 2
                spacing: dp(15)
                padding: dp(20)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Secure Login"
                    font_size: sp(24)
                    color: 1, 1, 1, 1
                    halign: "center"
                    valign: "middle"
                    size_hint_y: None
                    text_size: (self.width, None)
                    height: self.texture_size[1] + dp(10)

                # Account Details Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.15, 0.3, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "Account Details"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: phone_input
                        hint_text: "Email / Username / Phone"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "Password"
                            password: login_password_toggle.state != "down"
                            multiline: False
                            font_size: sp(16)
                            size_hint: 1, 1
                            background_color: (0.95, 0.95, 0.95, 1)
                            foreground_color: (0.1, 0.1, 0.1, 1)
                            padding: [dp(10), dp(10), dp(40), dp(10)]
                        ToggleButton:
                            id: login_password_toggle
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {"right": 1, "center_y": 0.5}
                            text: ""
                            background_normal: ""
                            background_down: ""
                            background_color: (0,0,0,0)
                            color: (0.2, 0.2, 0.2, 1)
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    BoxLayout:
                        size_hint_y: None
                        height: dp(32)
                        spacing: dp(10)
                        CheckBox:
                            id: remember_me
                            size_hint: None, None
                            size: dp(32), dp(32)
                            active: root.remember_me
                            on_active: root.remember_me = self.active
                        Label:
                            text: "Keep me logged in"
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    Button:
                        text: "Request OTP"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.9, 0.6, 0.2, 1)
                        on_release: root.send_otp_to_user()

                # OTP Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.2, 0.1, 0.25, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "OTP Verification"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: otp_input
                        hint_text: "Enter OTP"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    Button:
                        text: "Verify & Login"
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.3, 0.8, 0.4, 1)
                        on_release: root.verify_and_login()

                    Button:
                        text: "Login as Guest"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.3, 0.5, 0.9, 1)
                        on_release: root.login_as_guest()

                    Button:
                        text: "Forgot Password?"
                        size_hint_y: None
                        height: dp(40)
                        background_color: (0, 0, 0, 0)
                        on_release: root.open_forgot_password()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ForgotPasswordScreen>:
    name: "forgot_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: root.header_text
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: phone_input
                    hint_text: "Registered Phone/Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)

                Button:
                    text: "Send OTP"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.send_reset_otp()

                TextInput:
                    id: otp_input
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    disabled: not root.otp_stage_ready

                Button:
                    id: verify_btn
                    text: "Verify OTP"
                    size_hint_y: None
                    height: dp(48)
                    disabled: not root.otp_stage_ready
                    on_release: root.verify_otp_and_continue()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ResetPasswordScreen>:
    name: "reset_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Reset Password"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "New Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: confirm_password_input
                        hint_text: "Confirm Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: confirm_password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                Button:
                    text: "Save Password"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_new_password()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<settings>:
    name: "edit_profile"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Edit Profile"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: name_input
                    text: root.current_name
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                TextInput:
                    id: image_url_input
                    text: ""
                    hint_text: ""
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    disabled: True

                Button:
                    text: "Save Changes"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_profile()

                # Current profile photo preview + upload button
                BoxLayout:
                    size_hint_y: None
                    height: dp(90)
                    spacing: dp(10)

                    AsyncImage:
                        source: root.current_image_url if root.current_image_url else ""
                        size_hint: None, None
                        size: dp(80), dp(80)
                        fit_mode: "cover"

                    BoxLayout:
                        orientation: "vertical"
                        spacing: dp(6)
                        Label:
                            text: "Profile photo"
                            size_hint_y: None
                            height: dp(20)
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                        Button:
                            text: "Upload Image"
                            size_hint_y: None
                            height: dp(44)
                            background_color: (0.2, 0.5, 0.9, 1)
                            on_release: root.pick_image()

                Label:
                    text: "Options"
                    size_hint_y: None
                    height: dp(30)
                    color: 1, 1, 1, 0.7

                Button:
                    text: "Messages"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.5, 0.8, 1)
                    on_release: root.go_history()

                Button:
                    text: "Change Password"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.5, 0.8, 1)
                    on_release: root.change_password()

                Label:
                    text: "Subscribe"
                    size_hint_y: None
                    height: dp(30)
                    color: 1, 1, 1, 0.7
                
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: dp(100)
                    spacing: dp(5)
                    Button:
                        text: "Text 1h"
                        on_release: root.subscribe("text_hour")
                    Button:
                        text: "Text 10m"
                        on_release: root.subscribe("text_10min")
                    Button:
                        text: "Video 1h"
                        on_release: root.subscribe("video_hour")
                    Button:
                        text: "Video 10m"
                        on_release: root.subscribe("video_10min")

                Button:
                    text: "Logout"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.8, 0.2, 0.2, 1)
                    on_release: root.logout()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.94, 0.94
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.92, dp(600))
                spacing: dp(12)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Create Account"
                    font_size: sp(26)
                    size_hint_y: None
                    height: dp(50)

                TextInput:
                    id: name_input
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: phone_input
                    hint_text: "Username"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: email_input
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)

                Spinner:
                    id: country_spinner
                    text: "Select Country"
                    values: root.country_values()
                    size_hint_y: None
                    height: dp(48)

                Spinner:
                    id: gender_spinner
                    text: "male"
                    values: ["male", "female", "cross"]
                    size_hint_y: None
                    height: dp(48)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "Password"
                        password: True
                        size_hint: 1, 1
                        padding: [dp(10), dp(10), dp(40), dp(10)]
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                Button:
                    text: "Register"
                    size_hint_y: None
                    height: dp(50)
                    background_color: (0.3, 0.7, 0.3, 1)
                    on_release: root.save_profile()

                Button:
                    text: "Login via Gmail"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.9, 0.6, 0.2, 1)
                    on_release: root.social_login("gmail")

                Button:
                    text: "Login via FB / Insta"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.4, 0.9, 1)
                    on_release: root.social_login("fb/insta")

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

