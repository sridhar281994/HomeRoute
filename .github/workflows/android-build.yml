name: Android APK (Buildozer)

on:
  workflow_dispatch:
  push:
    paths:
      - "mobile/**"
      - ".github/workflows/android-build.yml"

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Restore stable keystore used by buildozer.spec
      # buildozer.spec expects: mobile/flatnow-debug.keystore (in mobile/ working dir)
      # ------------------------------------------------------------
      - name: Restore Android debug keystore
        env:
          ANDROID_DEBUG_KEYSTORE_BASE64: ${{ secrets.ANDROID_DEBUG_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail

          if [ -z "${ANDROID_DEBUG_KEYSTORE_BASE64}" ]; then
            echo "Missing required secret ANDROID_DEBUG_KEYSTORE_BASE64."
            echo "Google Sign-In will fail with status=10 if the signing SHA-1 changes each build."
            echo "Add a stable debug.keystore to GitHub Secrets and re-run."
            exit 1
          fi

          echo "${ANDROID_DEBUG_KEYSTORE_BASE64}" | base64 --decode > mobile/flatnow-debug.keystore
          chmod 600 mobile/flatnow-debug.keystore

          echo "Keystore restored:"
          ls -l mobile/flatnow-debug.keystore

      - name: Build debug APK (docker)
        run: |
          mkdir -p mobile/.buildozer mobile/.gradle mobile/bin
          # The container runs as a non-root user; ensure it can write to mounted volumes.
          chmod -R a+rwx mobile/.buildozer mobile/.gradle mobile/bin
          IMAGE="kivy/buildozer:latest"
          # Docker Hub is occasionally flaky/rate-limited in CI; retry pulls.
          for i in 1 2 3 4; do
            if docker pull "${IMAGE}"; then
              break
            fi
            sleep $((i*i*5))
          done
          docker image inspect "${IMAGE}" >/dev/null
          docker run --rm \
            --entrypoint bash \
            -e HOME=/home/user \
            -e USER=user \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -v "$GITHUB_WORKSPACE/mobile/.buildozer":/home/user/.buildozer \
            -v "$GITHUB_WORKSPACE/mobile/.gradle":/home/user/.gradle \
            -w /home/user/hostcwd/mobile \
            "${IMAGE}" \
            -lc '
              set -euo pipefail

              # Work around transient GitHub 5xx errors when SDL2 tries to fetch libwebp.
              # SDL2 may attempt: https://github.com/libsdl-org/libwebp.git
              # Redirect it to the stable upstream mirror.
              git config --global url."https://github.com/webmproject/libwebp.git".insteadOf https://github.com/libsdl-org/libwebp.git

              # Let buildozer create SDK/NDK folders first (it may exit early on missing licenses).
              # When piping `yes`, `yes` will often exit with SIGPIPE once buildozer is done.
              # With `pipefail` enabled this would fail the step, so temporarily disable it.
              set +o pipefail
              yes | buildozer android update || true
              set -o pipefail

              SDKROOT="/home/user/.buildozer/android/platform/android-sdk"
              LICENSE_DIR="${SDKROOT}/licenses"
              mkdir -p "${LICENSE_DIR}"

              # Write license files with known hashes (no interactive prompt).
              printf "%s\n" \
                "8933bad161af4178b1185d1a37fbf41ea5269c55" \
                "d56f5187479451eabf01fb78af6dfcb131a6481e" \
                > "${LICENSE_DIR}/android-sdk-license"
              printf "%s\n" \
                "84831b9409646a918e30573bab4c9c91346d8abd" \
                > "${LICENSE_DIR}/android-sdk-preview-license"

              # If sdkmanager exists, accept all licenses as well (future-proof).
              SDKMANAGER=""
              for p in \
                "${SDKROOT}/cmdline-tools/latest/bin/sdkmanager" \
                "${SDKROOT}/cmdline-tools/bin/sdkmanager" \
                "${SDKROOT}/tools/bin/sdkmanager"; do
                if [ -x "${p}" ]; then
                  SDKMANAGER="${p}"
                  break
                fi
              done
              if [ -n "${SDKMANAGER}" ]; then
                yes | "${SDKMANAGER}" --sdk_root="${SDKROOT}" --licenses || true
              fi

              # Buildozer (and underlying sdkmanager) may prompt for additional SDK licenses.
              # Pipe `yes` to avoid CI hanging on interactive prompts.
              set +o pipefail
              yes | buildozer android debug
              set -o pipefail

              echo ""
              echo "APK signing certificate fingerprints (this is what matters for Google Sign-In):"
              SDKROOT="/home/user/.buildozer/android/platform/android-sdk"
              APKSIGNER="$(ls -1 ${SDKROOT}/build-tools/*/apksigner 2>/dev/null | sort -V | tail -n 1)"
              if [ -z "${APKSIGNER}" ] || [ ! -x "${APKSIGNER}" ]; then
                echo "Could not locate apksigner under ${SDKROOT}/build-tools."
                exit 1
              fi
              shopt -s nullglob
              for apk in bin/*.apk; do
                echo ""
                echo "== ${apk} =="
                "${APKSIGNER}" verify --print-certs "${apk}" | sed -e "s/^/  /"
                echo ""
                echo "  Signing cert SHA-1 (extracted from APK):"
                ANDROID_SDK_ROOT="${SDKROOT}" python "/home/user/hostcwd/tools/print_apk_sha1.py" "${apk}" | sed -e "s/^/    /"
              done
            '

      - name: Print keystore SHA-1 (after packaging)
        run: |
          set -euo pipefail
          IMAGE="kivy/buildozer:latest"
          docker run --rm \
            --entrypoint bash \
            -e HOME=/home/user \
            -e USER=user \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -w /home/user/hostcwd \
            "${IMAGE}" \
            -lc '
              set -euo pipefail
              echo "Keystore certificate fingerprints (register SHA-1 in Firebase + Google OAuth Android client):"
              keytool -list -v \
                -keystore mobile/flatnow-debug.keystore \
                -alias flatnowdebug \
                -storepass android \
                -keypass android \
              | sed -n "s/^[[:space:]]*SHA1:[[:space:]]*//p; s/^[[:space:]]*SHA256:[[:space:]]*//p" \
              | sed -e "s/^/  /"
            '

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickrent-apk
          path: mobile/bin/*.apk
          if-no-files-found: error
