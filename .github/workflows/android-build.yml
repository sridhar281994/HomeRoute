name: Android APK (Buildozer)

on:
  workflow_dispatch:
  push:
    paths:
      - "mobile/**"
      - ".github/workflows/android-build.yml"

# ðŸ”’ Prevent GitHub from starving this heavy job
concurrency:
  group: android-build
  cancel-in-progress: false

jobs:
  build-apk:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Restore stable keystore used by buildozer.spec
      # ------------------------------------------------------------
      - name: Restore Android debug keystore
        env:
          ANDROID_DEBUG_KEYSTORE_BASE64: ${{ secrets.ANDROID_DEBUG_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail

          if [ -z "${ANDROID_DEBUG_KEYSTORE_BASE64}" ]; then
            echo "Missing required secret ANDROID_DEBUG_KEYSTORE_BASE64."
            exit 1
          fi

          echo "${ANDROID_DEBUG_KEYSTORE_BASE64}" | base64 --decode > mobile/flatnow-debug.keystore
          chmod 600 mobile/flatnow-debug.keystore
          ls -l mobile/flatnow-debug.keystore

      - name: Print keystore SHA-1 (before build)
        run: |
          set -euo pipefail
          IMAGE="kivy/buildozer:latest"
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -w /home/user/hostcwd \
            "${IMAGE}" \
            keytool -list -v \
              -keystore mobile/flatnow-debug.keystore \
              -alias flatnowdebug \
              -storepass android \
              -keypass android \
            | sed -n "s/^[[:space:]]*SHA1:[[:space:]]*//p"

      - name: Build debug APK (docker)
        run: |
          mkdir -p mobile/.buildozer mobile/.gradle mobile/bin
          chmod -R a+rwx mobile/.buildozer mobile/.gradle mobile/bin

          IMAGE="kivy/buildozer:latest"
          for i in 1 2 3 4; do
            docker pull "${IMAGE}" && break || sleep $((i*i*5))
          done

          docker run --rm \
            -e HOME=/home/user \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -v "$GITHUB_WORKSPACE/mobile/.buildozer":/home/user/.buildozer \
            -v "$GITHUB_WORKSPACE/mobile/.gradle":/home/user/.gradle \
            -w /home/user/hostcwd/mobile \
            "${IMAGE}" \
            bash -lc '
              set -e

              mkdir -p ~/.android
              keytool -importkeystore -noprompt \
                -srckeystore flatnow-debug.keystore \
                -srcalias flatnowdebug \
                -srcstorepass android \
                -srckeypass android \
                -destkeystore ~/.android/debug.keystore \
                -deststorepass android \
                -destkeypass android \
                -destalias androiddebugkey

              yes | buildozer android update || true
              yes | buildozer android debug
            '

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickrent-apk
          path: mobile/bin/*.apk
          if-no-files-found: error

  verify-artifact:
    name: Verify uploaded artifact
    needs: build-apk
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: quickrent-apk
          path: downloaded-apk

      - name: Inspect APK
        run: |
          set -e
          ls -l downloaded-apk
          for apk in downloaded-apk/*.apk; do
            echo "== $apk =="
            sha1sum "$apk"
            python3 tools/print_apk_sha1.py "$apk" || true
          done
