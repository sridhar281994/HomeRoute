name: Android APK (Buildozer)

on:
  workflow_dispatch:
  push:
    paths:
      - "mobile/**"
      - ".github/workflows/android-build.yml"

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build debug APK (docker)
        run: |
          mkdir -p mobile/.buildozer mobile/.gradle mobile/bin
          # The container runs as a non-root user; ensure it can write to mounted volumes.
          chmod -R a+rwx mobile/.buildozer mobile/.gradle mobile/bin
          IMAGE="kivy/buildozer:latest"
          # Docker Hub is occasionally flaky/rate-limited in CI; retry pulls.
          for i in 1 2 3 4; do
            if docker pull "${IMAGE}"; then
              break
            fi
            sleep $((i*i*5))
          done
          docker image inspect "${IMAGE}" >/dev/null
          docker run --rm \
            --entrypoint bash \
            -e HOME=/home/user \
            -e USER=user \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -v "$GITHUB_WORKSPACE/mobile/.buildozer":/home/user/.buildozer \
            -v "$GITHUB_WORKSPACE/mobile/.gradle":/home/user/.gradle \
            -w /home/user/hostcwd/mobile \
            "${IMAGE}" \
            -lc '
              set -euo pipefail

              # Let buildozer create SDK/NDK folders first (it may exit early on missing licenses).
              yes | buildozer android update || true

              SDKROOT="/home/user/.buildozer/android/platform/android-sdk"
              LICENSE_DIR="${SDKROOT}/licenses"
              mkdir -p "${LICENSE_DIR}"

              # Write license files with known hashes (no interactive prompt).
              printf "%s\n" \
                "8933bad161af4178b1185d1a37fbf41ea5269c55" \
                "d56f5187479451eabf01fb78af6dfcb131a6481e" \
                > "${LICENSE_DIR}/android-sdk-license"
              printf "%s\n" \
                "84831b9409646a918e30573bab4c9c91346d8abd" \
                > "${LICENSE_DIR}/android-sdk-preview-license"

              # If sdkmanager exists, accept all licenses as well (future-proof).
              SDKMANAGER=""
              for p in \
                "${SDKROOT}/cmdline-tools/latest/bin/sdkmanager" \
                "${SDKROOT}/cmdline-tools/bin/sdkmanager" \
                "${SDKROOT}/tools/bin/sdkmanager"; do
                if [ -x "${p}" ]; then
                  SDKMANAGER="${p}"
                  break
                fi
              done
              if [ -n "${SDKMANAGER}" ]; then
                yes | "${SDKMANAGER}" --sdk_root="${SDKROOT}" --licenses || true
              fi

              # Buildozer (and underlying sdkmanager) may prompt for additional SDK licenses.
              # Pipe `yes` to avoid CI hanging on interactive prompts.
              yes | buildozer android debug
            '

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickrent-apk
          path: mobile/bin/*.apk
          if-no-files-found: error

