name: Android APK (Buildozer)

on:
  workflow_dispatch:
  push:
    paths:
      - "mobile/**"
      - ".github/workflows/android-build.yml"

# ðŸ”’ Prevent GitHub from starving this heavy job
concurrency:
  group: android-build
  cancel-in-progress: false

jobs:
  build-apk:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Restore stable keystore used by buildozer.spec
      # ------------------------------------------------------------
      - name: Restore Android debug keystore
        env:
          ANDROID_DEBUG_KEYSTORE_BASE64: ${{ secrets.ANDROID_DEBUG_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail

          if [ -z "${ANDROID_DEBUG_KEYSTORE_BASE64}" ]; then
            echo "Missing required secret ANDROID_DEBUG_KEYSTORE_BASE64."
            exit 1
          fi

          echo "${ANDROID_DEBUG_KEYSTORE_BASE64}" | base64 --decode > mobile/flatnow-debug.keystore
          chmod 600 mobile/flatnow-debug.keystore
          ls -l mobile/flatnow-debug.keystore

      - name: Print keystore SHA-1 (before build)
        run: |
          set -euo pipefail
          IMAGE="kivy/buildozer:latest"
          docker run --rm \
            --entrypoint bash \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -w /home/user/hostcwd \
            "${IMAGE}" \
            -lc '
              set -euo pipefail

              KS="mobile/flatnow-debug.keystore"
              PASS="android"

              if [ ! -f "${KS}" ]; then
                echo "Keystore missing: ${KS}"
                exit 1
              fi

              # Some users provide a default debug.keystore (alias androiddebugkey),
              # others provide the recommended flatnowdebug alias.
              SRC_ALIAS="flatnowdebug"
              if ! keytool -list -keystore "${KS}" -storepass "${PASS}" -alias "${SRC_ALIAS}" >/dev/null 2>&1; then
                SRC_ALIAS="androiddebugkey"
              fi
              if ! keytool -list -keystore "${KS}" -storepass "${PASS}" -alias "${SRC_ALIAS}" >/dev/null 2>&1; then
                SRC_ALIAS="$(keytool -list -keystore "${KS}" -storepass "${PASS}" 2>/dev/null | sed -n "s/^\([^,]*\),.*/\1/p" | head -n1)"
              fi
              if [ -z "${SRC_ALIAS}" ]; then
                echo "Unable to detect alias in ${KS}. Ensure the keystore contains a key entry."
                exit 1
              fi

              echo "Detected keystore alias: ${SRC_ALIAS}"
              keytool -list -v \
                -keystore "${KS}" \
                -alias "${SRC_ALIAS}" \
                -storepass "${PASS}" \
                -keypass "${PASS}" \
              | sed -n "s/^[[:space:]]*SHA1:[[:space:]]*//p"
            '

      - name: Build debug APK (docker)
        run: |
          mkdir -p mobile/.buildozer mobile/.gradle mobile/bin
          chmod -R a+rwx mobile/.buildozer mobile/.gradle mobile/bin

          IMAGE="kivy/buildozer:latest"
          for i in 1 2 3 4; do
            docker pull "${IMAGE}" && break || sleep $((i*i*5))
          done

          docker run --rm \
            --entrypoint bash \
            -e HOME=/home/user \
            -v "$GITHUB_WORKSPACE":/home/user/hostcwd \
            -v "$GITHUB_WORKSPACE/mobile/.buildozer":/home/user/.buildozer \
            -v "$GITHUB_WORKSPACE/mobile/.gradle":/home/user/.gradle \
            -w /home/user/hostcwd/mobile \
            "${IMAGE}" \
            -lc '
              set -euo pipefail

              mkdir -p ~/.android

              KS="flatnow-debug.keystore"
              PASS="android"

              if [ ! -f "${KS}" ]; then
                echo "Keystore missing inside container: ${KS}"
                exit 1
              fi

              SRC_ALIAS="flatnowdebug"
              if ! keytool -list -keystore "${KS}" -storepass "${PASS}" -alias "${SRC_ALIAS}" >/dev/null 2>&1; then
                SRC_ALIAS="androiddebugkey"
              fi
              if ! keytool -list -keystore "${KS}" -storepass "${PASS}" -alias "${SRC_ALIAS}" >/dev/null 2>&1; then
                SRC_ALIAS="$(keytool -list -keystore "${KS}" -storepass "${PASS}" 2>/dev/null | sed -n "s/^\([^,]*\),.*/\1/p" | head -n1)"
              fi
              if [ -z "${SRC_ALIAS}" ]; then
                echo "Unable to detect alias in ${KS}. Ensure the keystore contains a key entry."
                exit 1
              fi

              echo "Importing ${KS} alias ${SRC_ALIAS} into ~/.android/debug.keystore as androiddebugkey"
              rm -f ~/.android/debug.keystore
              keytool -importkeystore -noprompt \
                -srckeystore "${KS}" \
                -srcalias "${SRC_ALIAS}" \
                -srcstorepass "${PASS}" \
                -srckeypass "${PASS}" \
                -destkeystore ~/.android/debug.keystore \
                -deststorepass "${PASS}" \
                -destkeypass "${PASS}" \
                -destalias androiddebugkey

              echo "debug.keystore SHA1:"
              keytool -list -v \
                -keystore ~/.android/debug.keystore \
                -alias androiddebugkey \
                -storepass "${PASS}" \
                -keypass "${PASS}" \
              | sed -n "s/^[[:space:]]*SHA1:[[:space:]]*//p"

              # buildozer can be interactive; piping "yes" prevents stalls.
              # IMPORTANT: disable pipefail so the SIGPIPE exit code from `yes`
              # (141) doesn't fail the CI job after a successful build.
              set +o pipefail
              yes | buildozer android update || true
              yes | buildozer android debug
            '

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickrent-apk
          path: mobile/bin/*.apk
          if-no-files-found: error

  verify-artifact:
    name: Verify uploaded artifact
    needs: build-apk
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: quickrent-apk
          path: downloaded-apk

      - name: Inspect APK
        run: |
          set -e
          ls -l downloaded-apk
          for apk in downloaded-apk/*.apk; do
            echo "== $apk =="
            sha1sum "$apk"
            python3 tools/print_apk_sha1.py "$apk" || true
          done
