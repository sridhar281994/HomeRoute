# Shiny purple theme (professional)
# NOTE: keep names stable to avoid touching every screen rule.
#:set BG_PURPLE (0.15, 0.05, 0.30, 1)               # lighter purple base
#:set SHINE_PURPLE (0.66, 0.33, 0.97, 0.30)         # purple shine (slightly stronger)
#:set SHINE_WHITE (1, 1, 1, 0.14)
#:set PANEL_BG (1, 1, 1, 0.17)
#:set CARD_BG (0, 0, 0, 0.28)
#:set TEXT_MAIN (1, 1, 1, 0.92)
#:set TEXT_MUTED (1, 1, 1, 0.68)
#:set ACCENT_PURPLE (0.66, 0.33, 0.97, 1)
#:set ACCENT_PURPLE_MUTED (0.66, 0.33, 0.97, 0.82)
#:set ACCENT_BLUE (0.38, 0.65, 0.98, 1)
#:set BTN_BG (1, 1, 1, 0.96)

# Global typography (bold-ish via markup)
<Label>:
    markup: True
    bold: True
    color: TEXT_MAIN
    font_name: "AppFont"

<Button>:
    markup: True
    font_size: sp(16)
    bold: True
    font_name: "AppFont"
    color: ACCENT_PURPLE

<TextInput>:
    font_name: "AppFont"
    background_normal: ""
    background_active: ""
    background_color: (1, 1, 1, 0.18)
    foreground_color: TEXT_MAIN
    cursor_color: TEXT_MAIN
    selection_color: (0.66, 0.33, 0.97, 0.35)
    padding: [dp(12), dp(10), dp(12), dp(10)]

<AppButton@HoverButton>:
    markup: True
    font_size: sp(16)
    bold: True
    font_name: "AppFont"
    background_normal: ""
    background_down: ""
    background_disabled_normal: ""
    background_color: BTN_BG
    color: ACCENT_PURPLE
    disabled_color: ACCENT_PURPLE_MUTED
    # Use the existing `background_color` set by screens as the base color.
    # Hover/pressed is computed automatically (desktop hover; press everywhere).
    canvas.before:
        PushMatrix:
        Scale:
            x: self.ux_scale
            y: self.ux_scale
            z: 1
            origin: self.center

        # Soft shadow (skip for transparent buttons / disabled).
        Color:
            rgba: (0, 0, 0, 0) if (self.disabled or self.background_color[3] < 0.05) else (0, 0, 0, self.shadow_alpha)
        RoundedRectangle:
            pos: self.x, self.y - dp(self.shadow_offset_y)
            size: self.size
            radius: [14]

        Color:
            rgba:
                (0, 0, 0, 0) if self.background_color[3] == 0 else (
                (
                max(0.0, self.background_color[0] - 0.10),
                max(0.0, self.background_color[1] - 0.10),
                max(0.0, self.background_color[2] - 0.10),
                self.background_color[3]
                ) if self.state == "down" else (
                min(1.0, self.background_color[0] + 0.08),
                min(1.0, self.background_color[1] + 0.08),
                min(1.0, self.background_color[2] + 0.08),
                self.background_color[3]
                ) if self.hovered else self.background_color
                )
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

        # Ripple (clipped to rounded rectangle).
        StencilPush:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilUse:
        Color:
            rgba: (1, 1, 1, 0) if self.disabled else (1, 1, 1, self.ripple_alpha)
        Ellipse:
            size: (self.ripple_radius * 2.0), (self.ripple_radius * 2.0)
            pos: (self.ripple_pos[0] - self.ripple_radius), (self.ripple_pos[1] - self.ripple_radius)
        StencilUnUse:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilPop:

        Color:
            rgba: (1, 1, 1, 0) if self.background_color[3] == 0 else (1, 1, 1, 0.85)
        Line:
            width: 1.1
            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]
    canvas.after:
        PopMatrix:

<NavButton@AppButton>:
    size_hint_x: None
    width: max(self.texture_size[0] + dp(28), dp(88))
    size_hint_y: None
    height: dp(40)
    text_size: (None, None)
    halign: "center"
    valign: "middle"
    padding: [dp(12), dp(8)]

<NavButtonWrap@NavButton>:
    size_hint_x: 1
    width: 0
    text_size: self.size
    halign: "center"
    valign: "middle"
    padding: [dp(8), dp(6)]

<AppToggle@HoverToggleButton>:
    markup: True
    font_size: sp(16)
    bold: True
    font_name: "AppFont"
    background_normal: ""
    background_down: ""
    background_disabled_normal: ""
    # Ensure selected state has strong contrast:
    # - active: purple background + white text
    # - inactive: white background + purple text + purple outline
    background_color: ACCENT_PURPLE if self.state == "down" else BTN_BG
    color: (1, 1, 1, 1) if self.state == "down" else ACCENT_PURPLE
    canvas.before:
        PushMatrix:
        Scale:
            x: self.ux_scale
            y: self.ux_scale
            z: 1
            origin: self.center

        Color:
            rgba: (0, 0, 0, 0) if (self.disabled or self.background_color[3] < 0.05) else (0, 0, 0, self.shadow_alpha)
        RoundedRectangle:
            pos: self.x, self.y - dp(self.shadow_offset_y)
            size: self.size
            radius: [14]

        Color:
            rgba:
                (0, 0, 0, 0) if self.background_color[3] == 0 else (
                (
                max(0.0, self.background_color[0] - 0.10),
                max(0.0, self.background_color[1] - 0.10),
                max(0.0, self.background_color[2] - 0.10),
                self.background_color[3]
                ) if self.state == "down" else (
                min(1.0, self.background_color[0] + 0.08),
                min(1.0, self.background_color[1] + 0.08),
                min(1.0, self.background_color[2] + 0.08),
                self.background_color[3]
                ) if self.hovered else self.background_color
                )
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

        StencilPush:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilUse:
        Color:
            rgba: (1, 1, 1, 0) if self.disabled else (1, 1, 1, self.ripple_alpha)
        Ellipse:
            size: (self.ripple_radius * 2.0), (self.ripple_radius * 2.0)
            pos: (self.ripple_pos[0] - self.ripple_radius), (self.ripple_pos[1] - self.ripple_radius)
        StencilUnUse:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilPop:

        Color:
            rgba:
                (1, 1, 1, 0) if self.background_color[3] == 0 else (
                (1, 1, 1, 0.9) if self.state == "down" else (ACCENT_PURPLE[0], ACCENT_PURPLE[1], ACCENT_PURPLE[2], 0.55)
                )
        Line:
            width: 1.1
            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]
    canvas.after:
        PopMatrix:

<PrettySpinnerOption@SpinnerOption>:
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    color: (0.12, 0.12, 0.12, 1)
    size_hint_y: None
    height: dp(44)
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.98) if self.state == "normal" else (1, 0.97, 0.93, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10]
        Color:
            rgba: (0.82, 0.82, 0.82, 0.9)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

<PrettySpinner@Spinner>:
    option_cls: "PrettySpinnerOption"
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    color: TEXT_MAIN
    font_size: sp(16)
    font_name: "AppFont"
    padding: [dp(12), dp(10)]
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.18) if self.state == "normal" else (1, 1, 1, 0.22)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: (1, 1, 1, 0.55)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 12]

<SplashScreen>:
    name: "splash"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: (1.0, 0.72, 0.25, 0.16)
            Ellipse:
                size: self.width * 0.9, self.height * 0.6
                pos: self.center_x - self.width * 0.45, self.center_y - self.height * 0.25
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        Image:
            source: "assets/QuickRent.png"
            allow_stretch: True
            keep_ratio: True
            size_hint: None, None
            size: min(root.width * 0.7, dp(320)), min(root.width * 0.7, dp(320))
            pos_hint: {"center_x": 0.5, "center_y": 0.55}

        Label:
            text: "Loading..."
            font_size: sp(16)
            color: 1, 1, 1, 0.7
            pos_hint: {"center_x": 0.5, "center_y": 0.38}

<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: (1.0, 0.72, 0.25, 0.14)
            Ellipse:
                size: self.width * 0.9, self.height * 0.6
                pos: self.center_x - self.width * 0.45, self.center_y - self.height * 0.25
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: 'vertical'
            size_hint: None, None
            # Responsive width/height
            width: min(root.width * 0.9, dp(600))
            height: min(self.minimum_height, root.height * 0.85)
            spacing: dp(20)
            padding: dp(20)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 20]

            Image:
                source: "assets/flatnow.png"
                allow_stretch: True
                keep_ratio: True
                size_hint_y: None
                height: dp(140)

            AppButton:
                text: "Login"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                on_release: root.manager.current = 'login'

            AppButton:
                text: "Register  [font=EmojiFont]‚ú®[/font]"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                on_release: root.manager.current = 'register'

            AppButton:
                text: "Continue as Guest"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                on_release: root.continue_as_guest()

        Label:
            text: "¬© 2025 SRTech Games"
            font_size: min(root.width * 0.035, sp(14))
            color: 1, 1, 1, 0.7
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5, "y": 0.05}

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False
            bar_width: 0

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                # ScrollView controls viewport size/pos when size_hint_x is set.
                # Using explicit width without disabling size_hint_x can cause repeated relayout loops.
                x: (root.width - self.width) / 2
                spacing: dp(15)
                padding: dp(20)
                canvas.before:
                    Color:
                        rgba: PANEL_BG
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]
                    Color:
                        rgba: (1, 1, 1, 0.12)
                    Line:
                        width: 1.0
                        rounded_rectangle: [self.x, self.y, self.width, self.height, 20]

                Label:
                    text: "[b]Secure Login[/b]  [font=EmojiFont]üîê[/font]"
                    font_size: sp(24)
                    halign: "center"
                    valign: "middle"
                    size_hint_y: None
                    text_size: (self.width, None)
                    height: self.texture_size[1] + dp(10)

                # Account Details Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: CARD_BG
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                        Color:
                            rgba: (1, 1, 1, 0.12)
                        Line:
                            width: 1.0
                            rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

                    Label:
                        text: "Account Details"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: phone_input
                        hint_text: "Email / Username / Phone"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (1, 1, 1, 0.18)
                        foreground_color: TEXT_MAIN

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "Password"
                            password: login_password_toggle.state != "down"
                            multiline: False
                            font_size: sp(16)
                            size_hint: 1, 1
                            background_color: (1, 1, 1, 0.18)
                            foreground_color: TEXT_MAIN
                            padding: [dp(10), dp(10), dp(40), dp(10)]
                        ToggleButton:
                            id: login_password_toggle
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {"right": 1, "center_y": 0.5}
                            text: ""
                            background_normal: ""
                            background_down: ""
                            background_color: (0,0,0,0)
                            color: (0.2, 0.2, 0.2, 1)
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    BoxLayout:
                        size_hint_y: None
                        height: dp(32)
                        spacing: dp(10)
                        CheckBox:
                            id: remember_me
                            size_hint: None, None
                            size: dp(32), dp(32)
                            active: root.remember_me
                            on_active: root.remember_me = self.active
                        Label:
                            text: "Keep me logged in"
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    BoxLayout:
                        size_hint_y: None
                        height: dp(32)
                        spacing: dp(10)
                        Label:
                            text: ""
                            size_hint_y: None
                            height: 0
                            opacity: 0

                    AppButton:
                        id: request_otp_btn
                        text: "Request OTP"
                        size_hint_y: None
                        height: dp(44)
                        on_press: root.send_otp_to_user()

                AppButton:
                    text: "Login via Gmail"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (1, 1, 1, 0.96)
                    color: (0.12, 0.12, 0.12, 1)
                    on_release: root.google_login()

                # OTP Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    opacity: 1
                    disabled: False
                    canvas.before:
                        Color:
                            rgba: CARD_BG
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                        Color:
                            rgba: (1, 1, 1, 0.12)
                        Line:
                            width: 1.0
                            rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

                    Label:
                        text: "OTP Verification"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: otp_input
                        hint_text: "Enter OTP"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (1, 1, 1, 0.18)
                        foreground_color: TEXT_MAIN

                    AppButton:
                        id: verify_login_btn
                        text: "Verify & Login"
                        size_hint_y: None
                        height: dp(48)
                        on_release: root.verify_and_login()

                    AppButton:
                        text: "Forgot Password?"
                        size_hint_y: None
                        height: dp(40)
                        background_color: (0, 0, 0, 0)
                        on_release: root.open_forgot_password()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.go_back()

<ForgotPasswordScreen>:
    name: "forgot_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: PANEL_BG
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]
                    Color:
                        rgba: (1, 1, 1, 0.12)
                    Line:
                        width: 1.0
                        rounded_rectangle: [self.x, self.y, self.width, self.height, 20]

                Label:
                    text: root.header_text
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: phone_input
                    hint_text: "Registered Phone/Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)

                AppButton:
                    text: "Send OTP"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.send_reset_otp()

                TextInput:
                    id: otp_input
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    disabled: not root.otp_stage_ready

                AppButton:
                    id: verify_btn
                    text: "Verify OTP"
                    size_hint_y: None
                    height: dp(48)
                    disabled: not root.otp_stage_ready
                    on_release: root.verify_otp_and_continue()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.go_back()

<ResetPasswordScreen>:
    name: "reset_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: PANEL_BG
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]
                    Color:
                        rgba: (1, 1, 1, 0.12)
                    Line:
                        width: 1.0
                        rounded_rectangle: [self.x, self.y, self.width, self.height, 20]

                Label:
                    text: "Reset Password"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "New Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: confirm_password_input
                        hint_text: "Confirm Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: confirm_password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                AppButton:
                    text: "Save Password"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.save_new_password()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.go_back()

<SettingsScreen>:
    name: "profile"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: PANEL_BG
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]
                    Color:
                        rgba: (1, 1, 1, 0.12)
                    Line:
                        width: 1.0
                        rounded_rectangle: [self.x, self.y, self.width, self.height, 20]

                Label:
                    text: "[b]Settings[/b]  [font=EmojiFont]‚öôÔ∏è[/font]"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                # Profile image + role
                BoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(110)
                    spacing: dp(12)
                    padding: [0, dp(6), 0, dp(6)]
                    canvas.before:
                        Color:
                            rgba: CARD_BG
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [14]
                        Color:
                            rgba: (1, 1, 1, 0.12)
                        Line:
                            width: 1.0
                            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]

                    AsyncImage:
                        source: root.profile_image_url if root.profile_image_url else root.default_profile_image
                        allow_stretch: True
                        keep_ratio: True
                        size_hint_x: None
                        width: dp(96)

                    BoxLayout:
                        orientation: "vertical"
                        spacing: dp(8)

                        TextInput:
                            id: role_display
                            text: "Owner" if root.role_value.lower() in ("owner", "admin") else "Customer"
                            hint_text: "Role"
                            size_hint_y: None
                            height: dp(42)
                            multiline: False
                            disabled: True

                        AppButton:
                            text: "Change Photo"
                            size_hint_y: None
                            height: dp(42)
                            on_release: root.open_image_picker()

                # Name update (server-backed)
                TextInput:
                    id: name_input
                    text: root.name_value
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Save Name  [font=EmojiFont]üíæ[/font]"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.save_name()

                # Current email/phone (read-only)
                TextInput:
                    id: phone_current
                    text: root.phone_value
                    hint_text: "Phone Number"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False
                    disabled: True

                TextInput:
                    id: email_current
                    text: root.email_value
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False
                    disabled: True

                # Change Email with OTP
                Label:
                    text: "[b]Change Email (OTP required)[/b]"
                    size_hint_y: None
                    height: dp(26)
                    color: 1, 1, 1, 0.9

                TextInput:
                    id: new_email_input
                    hint_text: "New Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Send Email OTP"
                    size_hint_y: None
                    height: dp(44)
                    on_release: root.request_email_otp()

                TextInput:
                    id: new_email_otp
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Verify & Update Email"
                    size_hint_y: None
                    height: dp(44)
                    on_release: root.verify_email_otp()

                # Change Phone with OTP
                Label:
                    text: "[b]Change Phone (OTP required)[/b]"
                    size_hint_y: None
                    height: dp(26)
                    color: 1, 1, 1, 0.9

                TextInput:
                    id: new_phone_input
                    hint_text: "New Phone"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Send Phone OTP"
                    size_hint_y: None
                    height: dp(44)
                    on_release: root.request_phone_otp()

                TextInput:
                    id: new_phone_otp
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Verify & Update Phone"
                    size_hint_y: None
                    height: dp(44)
                    on_release: root.verify_phone_otp()

                Label:
                    text: "Options"
                    size_hint_y: None
                    height: dp(30)
                    color: 1, 1, 1, 0.7

                AppButton:
                    text: "Change Password"
                    size_hint_y: None
                    height: dp(44)
                    on_release:
                        root.manager.get_screen("forgot_password").open_from(source_screen="profile", title="Change Password")
                        root.manager.current = "forgot_password"

                AppButton:
                    text: "Logout"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.logout()

                AppButton:
                    text: "Delete account"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.delete_account()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.go_back()

<SubscriptionScreen>:
    name: "subscription"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.9, 0.7
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

            Label:
                text: "[b]Subscription[/b]  [font=EmojiFont]üí≥[/font]"
                font_size: sp(24)
                size_hint_y: None
                height: dp(40)

            Label:
                text: root.status_text
                size_hint_y: None
                height: dp(28)
                color: 1, 1, 1, 0.9

            Label:
                text: root.provider_text
                size_hint_y: None
                height: dp(24)
                color: TEXT_MUTED

            Label:
                text: root.expires_text
                size_hint_y: None
                height: dp(24)
                color: TEXT_MUTED

            AppButton:
                text: "Refresh"
                size_hint_y: None
                height: dp(44)
                on_release: root.refresh_status()

            AppButton:
                text: "Back"
                size_hint_y: None
                height: dp(44)
                color: (0.94, 0.27, 0.27, 1)
                on_release: root.go_back()

<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.94, 0.94
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.92, dp(600))
                spacing: dp(12)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: PANEL_BG
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]
                    Color:
                        rgba: (1, 1, 1, 0.12)
                    Line:
                        width: 1.0
                        rounded_rectangle: [self.x, self.y, self.width, self.height, 20]

                Label:
                    text: "[b]Create Account[/b]  [font=EmojiFont]‚ú®[/font]"
                    font_size: sp(26)
                    size_hint_y: None
                    height: dp(50)

                TextInput:
                    id: name_input
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: phone_input
                    hint_text: "Phone Number"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: email_input
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)

                Label:
                    text: "[b]Choose Role[/b]"
                    size_hint_y: None
                    height: dp(22)
                    color: TEXT_MUTED

                # Role selection: Owner / Customer
                BoxLayout:
                    size_hint_y: None
                    height: dp(48)
                    spacing: dp(10)
                    AppToggle:
                        id: role_owner_btn
                        text: "[b]Owner[/b]  [font=EmojiFont]üè¢[/font]"
                        # Bind visual state to the screen role, so the "active" style
                        # never shifts to the wrong button.
                        state: "down" if root.role == "owner" else "normal"
                        on_release: root.set_role("owner")
                    AppToggle:
                        id: role_customer_btn
                        text: "[b]Customer[/b]  [font=EmojiFont]üßç[/font]"
                        state: "down" if root.role == "customer" else "normal"
                        on_release: root.set_role("customer")

                # Hidden role holder used by python (simple + reliable)
                TextInput:
                    id: role_value
                    text: "customer"
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    disabled: True

                # Owner category (only for Owner)
                BoxLayout:
                    id: owner_category_box
                    orientation: "vertical"
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    disabled: True
                    spacing: dp(8)
                    Label:
                        text: "[b]Choose Category[/b]  [font=EmojiFont]üèóÔ∏è[/font]"
                        size_hint_y: None
                        height: dp(24)
                        color: 1, 1, 1, 0.9
                    PrettySpinner:
                        id: owner_category_spinner
                        text: "Select Category"
                        values: root.owner_category_values()
                        size_hint_y: None
                        height: dp(48)

                Label:
                    text: "[b]Choose Location[/b]"
                    size_hint_y: None
                    height: dp(22)
                    color: TEXT_MUTED

                PrettySpinner:
                    id: country_spinner
                    text: "Select State"
                    values: root.country_values()
                    size_hint_y: None
                    height: dp(48)
                    on_text: root.on_state_changed()

                PrettySpinner:
                    id: district_spinner
                    text: "Select District"
                    values: root.district_values()
                    size_hint_y: None
                    height: dp(48)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "Password"
                        password: True
                        size_hint: 1, 1
                        padding: [dp(10), dp(10), dp(40), dp(10)]
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                AppButton:
                    text: "[b]Register[/b]  [font=EmojiFont]‚úÖ[/font]"
                    size_hint_y: None
                    height: dp(50)
                    on_release: root.save_profile()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.go_back()

<HomeScreen>:
    name: "home"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
                source: root.bg_image
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                AppButton:
                    text: "Home"
                    size_hint_x: None
                    width: dp(90)
                    on_release: root.go_home()
                AppButton:
                    text: "Publish Ad"
                    size_hint_x: None
                    width: dp(130)
                    on_release: root.go_publish_ad()
                Widget:
                AppButton:
                    text: "Logout" if root.is_logged_in else "Exit Guest"
                    size_hint_x: None
                    width: dp(120)
                    color: (0.94, 0.27, 0.27, 1)
                    opacity: 1 if (root.is_logged_in or root.is_guest) else 0
                    disabled: not (root.is_logged_in or root.is_guest)
                    on_release: root.do_logout()

            BoxLayout:
                size_hint_y: None
                height: dp(36)
                spacing: dp(8)
                Label:
                    text: "[b]Uncover the Best, Good Luck[/b]"
                    font_name: "CursiveFont"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                    color: TEXT_MAIN
                BoxLayout:
                    size_hint_x: None
                    width: self.minimum_width if root.is_guest else 0
                    size_hint_y: None
                    height: dp(26) if root.is_guest else 0
                    padding: [dp(10), dp(3), dp(10), dp(3)]
                    opacity: 1 if root.is_guest else 0
                    canvas.before:
                        Color:
                            rgba: (1, 1, 1, 0.16)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [12]
                    Label:
                        text: "[b]Guest mode[/b]"
                        font_size: sp(12)
                        color: ACCENT_BLUE
                        size_hint: None, None
                        size: self.texture_size

            GridLayout:
                cols: 2
                size_hint_y: None
                height: self.minimum_height
                row_force_default: True
                row_default_height: dp(44)
                spacing: dp(8)
                AppButton:
                    text: "My Posts"
                    on_release: root.go_my_posts()
                AppButton:
                    text: "Settings"
                    on_release: root.go_settings()
                AppButton:
                    text: "Refresh"
                    on_release: root.refresh()

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                padding: [dp(4), dp(2), dp(4), dp(2)]
                spacing: dp(8)
                Label:
                    text: "Filters"
                    color: TEXT_MUTED
                    size_hint_x: None
                    width: dp(70)
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                Widget:
                AppButton:
                    text: "Open Filters"
                    size_hint_x: None
                    width: dp(150)
                    on_release: root.open_filters()

            Label:
                text: "Loading..." if root.is_loading else "Posts"
                size_hint_y: None
                height: dp(24)
                color: TEXT_MUTED

            ScrollView:
                id: feed_scroll
                size_hint_y: 1
                do_scroll_x: False
                bar_width: dp(6)
                GridLayout:
                    id: list_container
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)

<FilterPopup>:
    # Use a full-screen modal overlay and draw our own rounded panel,
    # so the popup matches the Home screen card/panel theme.
    title: ""
    separator_height: 0
    size_hint: 1, 1
    auto_dismiss: True
    background: ""
    background_color: (0, 0, 0, 0)
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                Label:
                    text: "[b]Filters[/b]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                Widget:
                AppButton:
                    text: "Close"
                    size_hint_x: None
                    width: dp(110)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.dismiss()

            Label:
                text: "[b]Search & Filters[/b]"
                size_hint_y: None
                height: dp(22)
                color: TEXT_MUTED

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "State (optional)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.state_value if root.home else "Any"
                            values: root.home.state_options if root.home else ["Any"]
                            on_text:
                                if root.home: root.home.state_value = self.text
                                if root.home: root.home.on_state_selected()
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "District (optional)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.district_value if root.home else "Any"
                            values: root.home.district_options if root.home else ["Any"]
                            disabled: (not root.home) or (root.home.state_value == "Any")
                            on_text:
                                if root.home: root.home.district_value = self.text
                                if root.home: root.home.on_district_selected()
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(118)
                        spacing: dp(4)
                        Label:
                            text: "Area (optional)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        AppButton:
                            text: "Select Areas"
                            disabled: (not root.home) or (root.home.state_value == "Any") or (root.home.district_value == "Any")
                            on_release:
                                if root.home: root.home.open_area_picker()
                            size_hint_y: None
                            height: dp(48)
                        Label:
                            text:
                                ("Any" if (not root.home) or (not root.home.selected_areas) else (
                                (", ".join(root.home.selected_areas[:2])) + (
                                (" (+" + str(len(root.home.selected_areas) - 2) + " more)") if len(root.home.selected_areas) > 2 else ""
                                )))
                            color: TEXT_MUTED
                            halign: "left"
                            valign: "middle"
                            text_size: self.size
                            size_hint_y: None
                            height: dp(44)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Nearby radius (km)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        TextInput:
                            text: root.home.radius_km if root.home else "20"
                            multiline: False
                            input_filter: "int"
                            on_text:
                                if root.home: root.home.radius_km = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(44)
                        spacing: dp(8)
                        Label:
                            text: root.home.gps_status if root.home else ""
                            color: TEXT_MUTED
                            halign: "left"
                            valign: "middle"
                            text_size: self.size
                    Widget:

                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(44)
                        spacing: dp(8)
                        AppButton:
                            text: "Enable GPS"
                            size_hint_x: None
                            width: dp(150)
                            on_release:
                                if root.home: root.home.enable_gps()
                        Label:
                            text: root.home.gps_msg if root.home else ""
                            color: TEXT_MUTED
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(96)
                        spacing: dp(4)
                        Label:
                            text: "Need category (materials / services / property)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(42)
                            halign: "left"
                            valign: "middle"
                            text_size: self.width, None
                        TextInput:
                            text: ("" if (root.home and root.home.need_category == "Any") else (root.home.need_category if root.home else ""))
                            hint_text: "Type to search‚Ä¶"
                            multiline: False
                            on_text:
                                if root.home: root.home.on_need_input_changed(self)
                            on_focus:
                                if root.home: root.home.on_need_input_focus(self, self.focus)
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Post date"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.posted_within_days if root.home else "Any"
                            values: ["Any", "Today", "Last 7 days", "Last 30 days", "Last 90 days"]
                            on_text:
                                if root.home: root.home.posted_within_days = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Sort (by budget)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.sort_budget if root.home else "Any (Newest)"
                            values: ["Any (Newest)", "Top (high to low)", "Bottom (low to high)"]
                            on_text:
                                if root.home: root.home.sort_budget = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Max budget"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        TextInput:
                            text: root.home.max_price if root.home else ""
                            multiline: False
                            input_filter: "int"
                            on_text:
                                if root.home: root.home.max_price = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Rent/Sale"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.rent_sale if root.home else "Any"
                            values: ["Any", "Rent", "Sale"]
                            on_text:
                                if root.home: root.home.rent_sale = self.text
                            size_hint_y: None
                            height: dp(48)

            BoxLayout:
                size_hint_y: None
                height: dp(48)
                spacing: dp(10)
                AppButton:
                    text: "Apply filters"
                    on_release:
                        if root.home: root.home.refresh()
                        root.dismiss()

<MyPostsScreen>:
    name: "my_posts"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                Label:
                    text: "[b]My Posts[/b]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                Widget:
                AppButton:
                    text: "Refresh"
                    size_hint_x: None
                    width: dp(100)
                    on_release: root.refresh()
                AppButton:
                    text: "Back"
                    size_hint_x: None
                    width: dp(90)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.back()

            Label:
                text: "Loading..." if root.is_loading else ""
                size_hint_y: None
                height: dp(22)
                color: TEXT_MUTED

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)
                GridLayout:
                    id: my_posts_container
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)

<PropertyDetailScreen>:
    name: "property_detail"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                AppButton:
                    text: "Back"
                    size_hint_x: None
                    width: dp(90)
                    on_release: root.back()
                Label:
                    text: "Property Detail"
                    color: 1, 1, 1, 1

            Label:
                text: root.property_data.get("title","(loading...)")
                color: 1, 1, 1, 1
                font_size: sp(20)
                size_hint_y: None
                height: dp(32)

            Label:
                text: (root.property_data.get("price_display") or "") + " ‚Ä¢ " + (root.property_data.get("location_display") or "")
                color: 1, 1, 1, 0.9
                size_hint_y: None
                height: dp(24)

            Label:
                text: "Amenities: " + (", ".join(root.property_data.get("amenities") or []) if root.property_data.get("amenities") else "‚Äî")
                color: 1, 1, 1, 0.85

            AppButton:
                text: "Unlock Contact"
                size_hint_y: None
                height: dp(50)
                on_release: root.unlock_contact()

            AppButton:
                text: "Share  [font=EmojiFont]üì§[/font]"
                size_hint_y: None
                height: dp(44)
                on_release: root.share_current()

<OwnerAddPropertyScreen>:
    name: "owner_add_property"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.9, 0.85
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]
            Label:
                text: "Publish Ad"
                font_size: sp(24)
                size_hint_y: None
                height: dp(40)
                color: 1, 1, 1, 1
            PrettySpinner:
                id: state_spinner
                text: "Select State"
                values: root.state_values()
                size_hint_y: None
                height: dp(44)
                on_text: root.on_state_changed()
            PrettySpinner:
                id: district_spinner
                text: "Select District"
                values: root.district_values()
                size_hint_y: None
                height: dp(44)
                on_text: root.on_district_changed()
            PrettySpinner:
                id: area_spinner
                text: "Select Area"
                values: root.area_values()
                size_hint_y: None
                height: dp(44)
            TextInput:
                id: title_input
                hint_text: "Title"
                multiline: False
                size_hint_y: None
                height: dp(44)
            PrettySpinner:
                id: category_spinner
                text: "Select Category"
                values: root.category_values()
                size_hint_y: None
                height: dp(44)
            PrettySpinner:
                id: rent_sale_spinner
                text: "Rent"
                values: ["Rent", "Sale"]
                size_hint_y: None
                height: dp(44)
            TextInput:
                id: price_input
                hint_text: "Price"
                multiline: False
                input_filter: "int"
                size_hint_y: None
                height: dp(44)
            TextInput:
                id: contact_phone_input
                hint_text: "Contact phone"
                multiline: False
                size_hint_y: None
                height: dp(44)
            # Media upload (optional): max 10 images + 1 video
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(6)
                Label:
                    text: "Upload media (optional)"
                    size_hint_y: None
                    height: dp(20)
                    color: 1, 1, 1, 0.85
                AppButton:
                    text: "Choose Photos / Video"
                    size_hint_y: None
                    height: dp(44)
                    on_release: root.open_media_picker()
                Label:
                    id: media_summary
                    text: ""
                    size_hint_y: None
                    height: dp(18)
                    color: 1, 1, 1, 0.75
            AppButton:
                id: submit_btn
                text: "Submit (goes to admin review)"
                size_hint_y: None
                height: dp(50)
                on_release: root.submit_listing()
            AppButton:
                text: "Back"
                size_hint_y: None
                height: dp(44)
                color: (0.94, 0.27, 0.27, 1)
                on_release: root.go_back()

