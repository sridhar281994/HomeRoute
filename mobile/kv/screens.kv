# Shiny purple theme (professional)
# NOTE: keep names stable to avoid touching every screen rule.
# Web theme parity (match `web/src/styles.css`)
# Background base: #3b0c7a
# Accent purple:  #a855f7
# Accent blue:    #60a5fa
# Panel/card/button opacity/borders match the web CSS closely.
#:set BG_PURPLE (0.231, 0.047, 0.478, 1)             # #3b0c7a
#:set SHINE_PURPLE (0.659, 0.333, 0.969, 0.26)       # rgba(168,85,247,.26)
#:set SHINE_WHITE (1, 1, 1, 0.22)                    # common web shine alpha
#:set PANEL_BG (1, 1, 1, 0.14)                       # --panel: rgba(255,255,255,.14)
#:set CARD_BG (0, 0, 0, 0.35)                        # .card: rgba(0,0,0,.35)
#:set TEXT_MAIN (1, 1, 1, 0.92)
#:set TEXT_MUTED (1, 1, 1, 0.68)
#:set ACCENT_PURPLE (0.66, 0.33, 0.97, 1)
#:set ACCENT_PURPLE_MUTED (0.66, 0.33, 0.97, 0.82)
#:set ACCENT_BLUE (0.38, 0.65, 0.98, 1)
#:set BTN_BG (1, 1, 1, 0.96)

# Global typography (bold-ish via markup)
<Label>:
    markup: True
    bold: True
    color: TEXT_MAIN
    font_name: "AppFont"

<Button>:
    markup: True
    font_size: sp(16)
    bold: True
    font_name: "AppFont"
    color: ACCENT_PURPLE

<TextInput>:
    font_name: "AppFont"
    background_normal: ""
    background_active: ""
    # We'll draw the background/border ourselves to match web radius/border.
    background_color: (0, 0, 0, 0)
    foreground_color: TEXT_MAIN
    cursor_color: TEXT_MAIN
    selection_color: (0.66, 0.33, 0.97, 0.35)
    padding: [dp(12), dp(10), dp(12), dp(10)]
    canvas.before:
        # Background
        Color:
            rgba: (1, 1, 1, 0.18)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        # Border
        Color:
            rgba: (1, 1, 1, 0.55)
        Line:
            width: 1.1
            rounded_rectangle: [self.x, self.y, self.width, self.height, 12]

<AppButton@HoverButton>:
    markup: True
    font_size: sp(16)
    bold: True
    font_name: "AppFont"
    background_normal: ""
    background_down: ""
    background_disabled_normal: ""
    background_color: BTN_BG
    color: ACCENT_PURPLE
    disabled_color: ACCENT_PURPLE_MUTED
    # Use the existing `background_color` set by screens as the base color.
    # Hover/pressed is computed automatically (desktop hover; press everywhere).
    canvas.before:
        PushMatrix:
        Scale:
            x: self.ux_scale
            y: self.ux_scale
            z: 1
            origin: self.center

        # Soft shadow (skip for transparent buttons / disabled).
        Color:
            rgba: (0, 0, 0, 0) if (self.disabled or self.background_color[3] < 0.05) else (0, 0, 0, self.shadow_alpha)
        RoundedRectangle:
            pos: self.x, self.y - dp(self.shadow_offset_y)
            size: self.size
            radius: [14]

        Color:
            rgba:
                (0, 0, 0, 0) if self.background_color[3] == 0 else (
                (
                max(0.0, self.background_color[0] - 0.10),
                max(0.0, self.background_color[1] - 0.10),
                max(0.0, self.background_color[2] - 0.10),
                self.background_color[3]
                ) if self.state == "down" else (
                min(1.0, self.background_color[0] + 0.08),
                min(1.0, self.background_color[1] + 0.08),
                min(1.0, self.background_color[2] + 0.08),
                self.background_color[3]
                ) if self.hovered else self.background_color
                )
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

        # Ripple (clipped to rounded rectangle).
        StencilPush:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilUse:
        Color:
            rgba: (1, 1, 1, 0) if self.disabled else (1, 1, 1, self.ripple_alpha)
        Ellipse:
            size: (self.ripple_radius * 2.0), (self.ripple_radius * 2.0)
            pos: (self.ripple_pos[0] - self.ripple_radius), (self.ripple_pos[1] - self.ripple_radius)
        StencilUnUse:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilPop:

        Color:
            rgba: (1, 1, 1, 0) if self.background_color[3] == 0 else (1, 1, 1, 0.90)
        Line:
            width: 1.1
            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]
    canvas.after:
        PopMatrix:

<NavButton@AppButton>:
    size_hint_x: None
    width: max(self.texture_size[0] + dp(28), dp(88))
    size_hint_y: None
    height: dp(40)
    text_size: (None, None)
    halign: "center"
    valign: "middle"
    padding: [dp(12), dp(8)]

<NavButtonWrap@NavButton>:
    size_hint_x: 1
    width: 0
    text_size: self.size
    halign: "center"
    valign: "middle"
    padding: [dp(8), dp(6)]

<AppToggle@HoverToggleButton>:
    markup: True
    font_size: sp(16)
    bold: True
    font_name: "AppFont"
    background_normal: ""
    background_down: ""
    background_disabled_normal: ""
    # Ensure selected state has strong contrast:
    # - active: purple background + white text
    # - inactive: white background + purple text + purple outline
    background_color: ACCENT_PURPLE if self.state == "down" else BTN_BG
    color: (1, 1, 1, 1) if self.state == "down" else ACCENT_PURPLE
    canvas.before:
        PushMatrix:
        Scale:
            x: self.ux_scale
            y: self.ux_scale
            z: 1
            origin: self.center

        Color:
            rgba: (0, 0, 0, 0) if (self.disabled or self.background_color[3] < 0.05) else (0, 0, 0, self.shadow_alpha)
        RoundedRectangle:
            pos: self.x, self.y - dp(self.shadow_offset_y)
            size: self.size
            radius: [14]

        Color:
            rgba:
                (0, 0, 0, 0) if self.background_color[3] == 0 else (
                (
                max(0.0, self.background_color[0] - 0.10),
                max(0.0, self.background_color[1] - 0.10),
                max(0.0, self.background_color[2] - 0.10),
                self.background_color[3]
                ) if self.state == "down" else (
                min(1.0, self.background_color[0] + 0.08),
                min(1.0, self.background_color[1] + 0.08),
                min(1.0, self.background_color[2] + 0.08),
                self.background_color[3]
                ) if self.hovered else self.background_color
                )
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

        StencilPush:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilUse:
        Color:
            rgba: (1, 1, 1, 0) if self.disabled else (1, 1, 1, self.ripple_alpha)
        Ellipse:
            size: (self.ripple_radius * 2.0), (self.ripple_radius * 2.0)
            pos: (self.ripple_pos[0] - self.ripple_radius), (self.ripple_pos[1] - self.ripple_radius)
        StencilUnUse:
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        StencilPop:

        Color:
            rgba:
                (1, 1, 1, 0) if self.background_color[3] == 0 else (
                (1, 1, 1, 0.9) if self.state == "down" else (ACCENT_PURPLE[0], ACCENT_PURPLE[1], ACCENT_PURPLE[2], 0.55)
                )
        Line:
            width: 1.1
            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]
    canvas.after:
        PopMatrix:

<PrettySpinnerOption@SpinnerOption>:
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    color: (0.12, 0.12, 0.12, 1)
    size_hint_y: None
    height: dp(44)
    # Ensure long option labels (e.g. Area names) render fully.
    # Without an explicit text_size/halign, some devices render only the first character.
    text_size: (self.width - dp(24)), None
    halign: "left"
    valign: "middle"
    padding: [dp(12), dp(8)]
    shorten: False
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.98) if self.state == "normal" else (1, 0.97, 0.93, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10]
        Color:
            rgba: (0.82, 0.82, 0.82, 0.9)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

<PrettySpinner@Spinner>:
    option_cls: "PrettySpinnerOption"
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    color: TEXT_MAIN
    font_size: sp(16)
    font_name: "AppFont"
    padding: [dp(12), dp(10)]
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.18) if self.state == "normal" else (1, 1, 1, 0.22)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: (1, 1, 1, 0.55)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 12]

# -----------------------
# Web-parity layout blocks
# -----------------------
<WebPanel@BoxLayout>:
    orientation: "vertical"
    size_hint_y: None
    height: self.minimum_height
    padding: dp(16)
    spacing: dp(12)
    canvas.before:
        Color:
            rgba: PANEL_BG
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
        Color:
            rgba: (1, 1, 1, 0.12)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

<WebCard@BoxLayout>:
    orientation: "vertical"
    size_hint_y: None
    height: self.minimum_height
    padding: dp(12)
    spacing: dp(10)
    canvas.before:
        Color:
            rgba: CARD_BG
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        Color:
            rgba: (1, 1, 1, 0.12)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]

<GuestPill@BoxLayout>:
    size_hint: None, None
    height: dp(28)
    padding: [dp(10), dp(4), dp(10), dp(4)]
    spacing: dp(6)
    canvas.before:
        Color:
            rgba: (0.38, 0.65, 0.98, 0.22)  # rgba(96,165,250,.22)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [999]
        Color:
            rgba: (0.38, 0.65, 0.98, 0.55)  # border rgba(96,165,250,.55)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 999]

<HamburgerButton@Button>:
    text: ""
    size_hint: None, None
    size: dp(44), dp(44)
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    canvas.before:
        # Button bg + border (matches the panel style).
        Color:
            rgba: (1, 1, 1, 0.18) if self.state == "down" else (1, 1, 1, 0.12)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: (1, 1, 1, 0.20)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 12]
        # Hamburger lines
        Color:
            rgba: (1, 1, 1, 0.92)
        Rectangle:
            pos: self.x + dp(12), self.center_y + dp(8)
            size: self.width - dp(24), dp(2)
        Rectangle:
            pos: self.x + dp(12), self.center_y - dp(1)
            size: self.width - dp(24), dp(2)
        Rectangle:
            pos: self.x + dp(12), self.center_y - dp(10)
            size: self.width - dp(24), dp(2)

<MobileTopBar@BoxLayout>:
    avatar_text: ""
    avatar_image: ""
    on_avatar_press: lambda: None

    orientation: "horizontal"
    size_hint_y: None
    height: dp(52)
    padding: [dp(6), 0, dp(6), 0]
    spacing: dp(10)

    HamburgerButton:
        on_release:
            app.root.current_screen.open_hamburger_menu(self) \
            if (app and app.root and app.root.current_screen) else None

    Widget:

    AvatarButton:
        image_source: root.avatar_image
        fallback_text: root.avatar_text
        on_release: root.on_avatar_press()

<AvatarButton@ButtonBehavior+FloatLayout>:
    image_source: ""
    fallback_text: "ME"
    has_image: bool(root.image_source)

    size_hint: None, None
    size: dp(44), dp(44)

    canvas.before:
        Color:
            rgba: (1, 1, 1, 1)
        Ellipse:
            pos: self.pos
            size: self.size

        Color:
            rgba: (0.85, 0.85, 0.85, 1)
        Line:
            width: 1.0
            ellipse: (self.x, self.y, self.width, self.height)

        StencilPush
        Ellipse:
            pos: self.pos
            size: self.size
        StencilUse

    canvas.after:
        StencilUnUse
        Ellipse:
            pos: self.pos
            size: self.size
        StencilPop

    AsyncImage:
        source: root.image_source
        allow_stretch: True
        keep_ratio: False
        size_hint: 1, 1
        opacity: 1 if root.has_image else 0
        on_error: root.image_source = ""

    Label:
        text: root.fallback_text if root.fallback_text else "ME"
        font_size: sp(16)
        color: (0.2, 0.2, 0.2, 1)
        halign: "center"
        valign: "middle"
        text_size: self.size
        size_hint: 1, 1
        opacity: 0 if root.has_image else 1


<AuthHeader@BoxLayout>:
    orientation: "vertical"
    size_hint_y: None
    height: self.minimum_height
    spacing: dp(2)
    padding: [0, dp(4), 0, dp(4)]
    Label:
        text: "[b]flatnow.in[/b]"
        markup: True
        font_size: sp(26)
        halign: "center"
        valign: "middle"
        text_size: self.width, None
        size_hint_y: None
        height: self.texture_size[1] + dp(4)
    Label:
        text: "UNLOCK your path"
        font_size: sp(14)
        color: TEXT_MUTED
        halign: "center"
        valign: "middle"
        text_size: self.width, None
        size_hint_y: None
        height: self.texture_size[1] + dp(2)

<SplashScreen>:
    name: "splash"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: (1.0, 0.72, 0.25, 0.16)
            Ellipse:
                size: self.width * 0.9, self.height * 0.6
                pos: self.center_x - self.width * 0.45, self.center_y - self.height * 0.25
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        Image:
            source: "assets/flatnow_all.png"
            fit_mode: "contain"
            size_hint: None, None
            size: min(root.width * 0.7, dp(320)), min(root.width * 0.7, dp(320))
            pos_hint: {"center_x": 0.5, "center_y": 0.55}

        Label:
            text: "Loading..."
            font_size: sp(16)
            color: 1, 1, 1, 0.7
            pos_hint: {"center_x": 0.5, "center_y": 0.38}

<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: (1.0, 0.72, 0.25, 0.14)
            Ellipse:
                size: self.width * 0.9, self.height * 0.6
                pos: self.center_x - self.width * 0.45, self.center_y - self.height * 0.25
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2

                    Image:
                        source: "assets/flatnow.png"
                        fit_mode: "contain"
                        size_hint_y: None
                        height: dp(140)

                    WebCard:
                        Label:
                            text: "[b]Welcome[/b]"
                            font_size: sp(18)
                            size_hint_y: None
                            height: dp(24)
                        Label:
                            text: "Login, register, or continue as Guest."
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)

                        AppButton:
                            text: "Login"
                            size_hint_y: None
                            height: dp(44)
                            on_release: app.root.current = "login"

                        AppButton:
                            text: "Login via Gmail"
                            size_hint_y: None
                            height: dp(44)
                            on_release: root.google_login()

                        AppButton:
                            text: "Register  [font=EmojiFont]‚ú®[/font]"
                            size_hint_y: None
                            height: dp(44)
                            on_release: app.root.current = "register"

                        AppButton:
                            text: "Continue as Guest"
                            size_hint_y: None
                            height: dp(44)
                            on_release: root.continue_as_guest()

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            ScrollView:
                id: login_scroll
                do_scroll_x: False
                bar_width: dp(6)
                scroll_type: ["content"]
                scroll_timeout: 150

                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2
                    spacing: dp(15)

                    AuthHeader:

                    Label:
                        text: "[b]Secure Login[/b]  [font=EmojiFont]üîê[/font]"
                        font_size: sp(24)
                        halign: "center"
                        valign: "middle"
                        size_hint_y: None
                        text_size: (self.width, None)
                        height: self.texture_size[1] + dp(10)

                    # Account Details Box
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(10)
                        padding: dp(10)
                        canvas.before:
                            Color:
                                rgba: CARD_BG
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [10]
                            Color:
                                rgba: (1, 1, 1, 0.12)
                            Line:
                                width: 1.0
                                rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

                        Label:
                            text: "Account Details"
                            font_size: sp(16)
                            color: 1, 1, 1, 0.9
                            size_hint_y: None
                            height: dp(30)

                        TextInput:
                            id: phone_input
                            hint_text: "Email / Username / Phone"
                            multiline: False
                            font_size: sp(16)
                            size_hint_y: None
                            height: dp(48)
                            background_color: (1, 1, 1, 0.18)
                            foreground_color: TEXT_MAIN
                            on_focus:
                                if self.focus: root.scroll_to_field(self)

                        RelativeLayout:
                            size_hint_y: None
                            height: dp(48)
                            TextInput:
                                id: password_input
                                hint_text: "Password"
                                password: login_password_toggle.state != "down"
                                multiline: False
                                font_size: sp(16)
                                size_hint: 1, 1
                                background_color: (1, 1, 1, 0.18)
                                foreground_color: TEXT_MAIN
                                padding: [dp(10), dp(10), dp(40), dp(10)]
                                on_focus:
                                    if self.focus: root.scroll_to_field(self)
                            ToggleButton:
                                id: login_password_toggle
                                size_hint: None, None
                                size: dp(40), dp(40)
                                pos_hint: {"right": 1, "center_y": 0.5}
                                text: ""
                                background_normal: ""
                                background_down: ""
                                background_color: (0,0,0,0)
                                color: (0.2, 0.2, 0.2, 1)
                                canvas:
                                    Color:
                                        rgba: 0.2, 0.2, 0.2, 1
                                    Line:
                                        width: 1.2
                                        ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                    Color:
                                        rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                    Ellipse:
                                        pos: self.x + dp(15), self.y + dp(15)
                                        size: dp(10), dp(10)
                                    Color:
                                        rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                    Line:
                                        points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                        width: 1.2

                        BoxLayout:
                            size_hint_y: None
                            height: dp(32)
                            spacing: dp(10)
                            CheckBox:
                                id: remember_me
                                size_hint: None, None
                                size: dp(32), dp(32)
                                active: root.remember_me
                                on_active: root.remember_me = self.active
                            Label:
                                text: "Keep me logged in"
                                color: 1, 1, 1, 0.9
                                halign: "left"
                                valign: "middle"
                                text_size: self.size

                        BoxLayout:
                            size_hint_y: None
                            height: dp(32)
                            spacing: dp(10)
                            Label:
                                text: ""
                                size_hint_y: None
                                height: 0
                                opacity: 0

                        AppButton:
                            id: request_otp_btn
                            text: "Request OTP"
                            size_hint_y: None
                            height: dp(44)
                            on_press: root.send_otp_to_user()

                    # OTP Box
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(10)
                        padding: dp(10)
                        opacity: 1
                        disabled: False
                        canvas.before:
                            Color:
                                rgba: CARD_BG
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [10]
                            Color:
                                rgba: (1, 1, 1, 0.12)
                            Line:
                                width: 1.0
                                rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

                        Label:
                            text: "OTP Verification"
                            font_size: sp(16)
                            color: 1, 1, 1, 0.9
                            size_hint_y: None
                            height: dp(30)

                        TextInput:
                            id: otp_input
                            hint_text: "Enter OTP"
                            multiline: False
                            font_size: sp(16)
                            size_hint_y: None
                            height: dp(48)
                            background_color: (1, 1, 1, 0.18)
                            foreground_color: TEXT_MAIN
                            on_focus:
                                if self.focus: root.scroll_to_field(self)

                        AppButton:
                            id: verify_login_btn
                            text: "Verify & Login"
                            size_hint_y: None
                            height: dp(48)
                            on_release: root.verify_and_login()

                        AppButton:
                            text: "Forgot Password?"
                            size_hint_y: None
                            height: dp(40)
                            background_color: (0, 0, 0, 0)
                            on_release: root.open_forgot_password()

                    AppButton:
                        text: "Back"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.go_back()

<ForgotPasswordScreen>:
    name: "forgot_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            MobileTopBar:

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2

                    Label:
                        text: root.header_text
                        font_size: sp(24)
                        size_hint_y: None
                        height: dp(40)

                    TextInput:
                        id: phone_input
                        hint_text: "Registered Phone/Email"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)

                    AppButton:
                        text: "Send OTP"
                        size_hint_y: None
                        height: dp(48)
                        on_release: root.send_reset_otp()

                    TextInput:
                        id: otp_input
                        hint_text: "Enter OTP"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        disabled: not root.otp_stage_ready

                    AppButton:
                        id: verify_btn
                        text: "Verify OTP"
                        size_hint_y: None
                        height: dp(48)
                        disabled: not root.otp_stage_ready
                        on_release: root.verify_otp_and_continue()

                    AppButton:
                        text: "Back"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.go_back()

<ResetPasswordScreen>:
    name: "reset_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            MobileTopBar:

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2

                    Label:
                        text: "Reset Password"
                        font_size: sp(24)
                        size_hint_y: None
                        height: dp(40)

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "New Password"
                            password: True
                            size_hint: 1, 1
                        ToggleButton:
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {'right': 1, 'center_y': 0.5}
                            text: ""
                            background_color: (0,0,0,0)
                            on_state: password_input.password = (self.state == 'normal')
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: confirm_password_input
                            hint_text: "Confirm Password"
                            password: True
                            size_hint: 1, 1
                        ToggleButton:
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {'right': 1, 'center_y': 0.5}
                            text: ""
                            background_color: (0,0,0,0)
                            on_state: confirm_password_input.password = (self.state == 'normal')
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    AppButton:
                        text: "Save Password"
                        size_hint_y: None
                        height: dp(48)
                        on_release: root.save_new_password()

                    AppButton:
                        text: "Back"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.go_back()

<SettingsScreen>:
    name: "profile"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            MobileTopBar:

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                BoxLayout:
                    orientation: "vertical"
                    size_hint_x: None
                    size_hint_y: None
                    height: self.minimum_height
                    width: min(root.width * 0.95, dp(980))
                    spacing: dp(15)
                    padding: dp(16)
                    x: (root.width - self.width) / 2
                    canvas.before:
                        Color:
                            rgba: PANEL_BG
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [16]
                        Color:
                            rgba: (1, 1, 1, 0.12)
                        Line:
                            width: 1.0
                            rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

                    Label:
                        text: "[b]Settings[/b]  [font=EmojiFont]‚öôÔ∏è[/font]"
                        font_size: sp(24)
                        size_hint_y: None
                        height: dp(40)

                    # Profile image + role
                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(110)
                        spacing: dp(12)
                        padding: [0, dp(6), 0, dp(6)]
                        canvas.before:
                            Color:
                                rgba: CARD_BG
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [14]
                            Color:
                                rgba: (1, 1, 1, 0.12)
                            Line:
                                width: 1.0
                                rounded_rectangle: [self.x, self.y, self.width, self.height, 14]

                        AsyncImage:
                            source: root.profile_image_url if root.profile_image_url else root.default_profile_image
                            fit_mode: "contain"
                            size_hint_x: None
                            width: dp(96)

                        BoxLayout:
                            orientation: "vertical"
                            spacing: dp(8)

                            TextInput:
                                id: role_display
                                text: "Owner" if root.role_value.lower() in ("owner", "admin") else "Customer"
                                hint_text: "Role"
                                size_hint_y: None
                                height: dp(42)
                                multiline: False
                                disabled: True

                            AppButton:
                                text: "Change Photo"
                                size_hint_y: None
                                height: dp(42)
                                on_release: root.open_image_picker()

                    # Name update (server-backed)
                    TextInput:
                        id: name_input
                        text: root.name_value
                        hint_text: "Full Name"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False

                    AppButton:
                        text: "Save Name  [font=EmojiFont]üíæ[/font]"
                        size_hint_y: None
                        height: dp(48)
                        on_release: root.save_name()

                    # Current email/phone (read-only)
                    TextInput:
                        id: phone_current
                        text: root.phone_value
                        hint_text: "Phone Number"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False
                        disabled: True

                    TextInput:
                        id: email_current
                        text: root.email_value
                        hint_text: "Email"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False
                        disabled: True

                    # Change Email with OTP
                    Label:
                        text: "[b]Change Email (OTP required)[/b]"
                        size_hint_y: None
                        height: dp(26)
                        color: 1, 1, 1, 0.9

                    TextInput:
                        id: new_email_input
                        hint_text: "New Email"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False

                    AppButton:
                        text: "Send Email OTP"
                        size_hint_y: None
                        height: dp(44)
                        on_release: root.request_email_otp()

                    TextInput:
                        id: new_email_otp
                        hint_text: "Enter OTP"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False

                    AppButton:
                        text: "Verify & Update Email"
                        size_hint_y: None
                        height: dp(44)
                        on_release: root.verify_email_otp()

                    # Change Phone with OTP
                    Label:
                        text: "[b]Change Phone (OTP required)[/b]"
                        size_hint_y: None
                        height: dp(26)
                        color: 1, 1, 1, 0.9

                    TextInput:
                        id: new_phone_input
                        hint_text: "New Phone"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False

                    AppButton:
                        text: "Send Phone OTP"
                        size_hint_y: None
                        height: dp(44)
                        on_release: root.request_phone_otp()

                    TextInput:
                        id: new_phone_otp
                        hint_text: "Enter OTP"
                        size_hint_y: None
                        height: dp(48)
                        font_size: sp(16)
                        multiline: False

                    AppButton:
                        text: "Verify & Update Phone"
                        size_hint_y: None
                        height: dp(44)
                        on_release: root.verify_phone_otp()

                    Label:
                        text: "Options"
                        size_hint_y: None
                        height: dp(30)
                        color: 1, 1, 1, 0.7

                    AppButton:
                        text: "Change Password"
                        size_hint_y: None
                        height: dp(44)
                        on_release:
                            root.manager.get_screen("forgot_password").open_from(source_screen="profile", title="Change Password")
                            root.manager.current = "forgot_password"

                    AppButton:
                        text: "Logout"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.logout()

                    AppButton:
                        text: "Delete account"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.delete_account()

                    AppButton:
                        text: "Back"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.go_back()

<SubscriptionScreen>:
    name: "subscription"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            MobileTopBar:

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)
                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2

                    WebCard:
                        Label:
                            text: "[b]Subscription[/b]  [font=EmojiFont]üí≥[/font]"
                            font_size: sp(18)
                            size_hint_y: None
                            height: dp(26)
                        Label:
                            text: root.status_text
                            size_hint_y: None
                            height: dp(24)
                            color: TEXT_MAIN
                        Label:
                            text: root.expires_text
                            size_hint_y: None
                            height: dp(22)
                            color: TEXT_MUTED

                        AppButton:
                            text: "[b]FREE - 0[/b]\nUnlock 30 owner/service contacts"
                            size_hint_x: 1
                            size_hint_y: None
                            height: dp(64)
                        
                        AppButton:
                            text: "[b]INSTANT - ‚Çπ10[/b]\nUnlock 60 owner/service contacts"
                            size_hint_x: 1
                            size_hint_y: None
                            height: dp(64)
                        
                        AppButton:
                            text: "[b]SMART - ‚Çπ50[/b]\nUnlock 200 contacts"
                            size_hint_x: 1
                            size_hint_y: None
                            height: dp(64)
                        
                        AppButton:
                            text: "[b]BUSINESS - ‚Çπ150[/b]\nUnlimited contact unlocks/Month"
                            size_hint_x: 1
                            size_hint_y: None
                            height: dp(64)
                        
                        AppButton:
                            text: "Back"
                            size_hint_x: 1
                            size_hint_y: None
                            height: dp(44)
                            color: (0.94, 0.27, 0.27, 1)
                            on_release: root.go_back()


<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2
                    spacing: dp(12)

                    AuthHeader:

                    Label:
                        text: "[b]Create Account[/b]  [font=EmojiFont]‚ú®[/font]"
                        font_size: sp(26)
                        size_hint_y: None
                        height: dp(50)

                    TextInput:
                        id: name_input
                        hint_text: "Full Name"
                        size_hint_y: None
                        height: dp(48)

                    TextInput:
                        id: phone_input
                        hint_text: "Phone Number"
                        size_hint_y: None
                        height: dp(48)

                    TextInput:
                        id: email_input
                        hint_text: "Email"
                        size_hint_y: None
                        height: dp(48)

                    Label:
                        text: "[b]Choose Role[/b]"
                        size_hint_y: None
                        height: dp(22)
                        color: TEXT_MUTED

                    # Role selection: Owner / Customer
                    BoxLayout:
                        size_hint_y: None
                        height: dp(48)
                        spacing: dp(10)
                        AppToggle:
                            id: role_owner_btn
                            text: "[b]Owner[/b]  [font=EmojiFont]üè¢[/font]"
                            # Bind visual state to the screen role, so the "active" style
                            # never shifts to the wrong button.
                            state: "down" if root.role == "owner" else "normal"
                            on_release: root.set_role("owner")
                        AppToggle:
                            id: role_customer_btn
                            text: "[b]Customer[/b]  [font=EmojiFont]üßç[/font]"
                            state: "down" if root.role == "customer" else "normal"
                            on_release: root.set_role("customer")

                    # Hidden role holder used by python (simple + reliable)
                    TextInput:
                        id: role_value
                        text: "customer"
                        size_hint_y: None
                        height: 0
                        opacity: 0
                        disabled: True

                    # Owner category (only for Owner)
                    BoxLayout:
                        id: owner_category_box
                        orientation: "vertical"
                        size_hint_y: None
                        height: 0
                        opacity: 0
                        disabled: True
                        spacing: dp(8)
                        Label:
                            text: "[b]Choose Category[/b]  [font=EmojiFont]üèóÔ∏è[/font]"
                            size_hint_y: None
                            height: dp(24)
                            color: 1, 1, 1, 0.9
                        PrettySpinner:
                            id: owner_category_spinner
                            text: "Select Category"
                            values: root.owner_category_values()
                            size_hint_y: None
                            height: dp(48)

                    Label:
                        text: "[b]Choose Location[/b]"
                        size_hint_y: None
                        height: dp(22)
                        color: TEXT_MUTED

                    PrettySpinner:
                        id: country_spinner
                        text: "Select State"
                        values: root.country_values()
                        size_hint_y: None
                        height: dp(48)
                        on_text: root.on_state_changed()

                    PrettySpinner:
                        id: district_spinner
                        text: "Select District"
                        values: root.district_values()
                        size_hint_y: None
                        height: dp(48)

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "Password"
                            password: True
                            size_hint: 1, 1
                            padding: [dp(10), dp(10), dp(40), dp(10)]
                        ToggleButton:
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {'right': 1, 'center_y': 0.5}
                            text: ""
                            background_color: (0,0,0,0)
                            on_state: password_input.password = (self.state == 'normal')
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    AppButton:
                        text: "[b]Register[/b]  [font=EmojiFont]‚úÖ[/font]"
                        size_hint_y: None
                        height: dp(50)
                        on_release: root.save_profile()

                    AppButton:
                        text: "Back"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.go_back()

<HomeScreen>:
    name: "home"

    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
                source: root.bg_image
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            # -------------------------------
            # TOP BAR (Avatar wired correctly)
            # -------------------------------
            MobileTopBar:
                avatar_text: root.avatar_letter
                avatar_image: root.profile_image_url
                on_avatar_press: root.go_profile()

            # -------------------------------
            # MAIN PANEL
            # -------------------------------
            WebPanel:
                size_hint_y: 1
                spacing: dp(10)

                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: home_tagline.texture_size[1] + dp(10) + action_row.height
                    spacing: dp(6)

                    Label:
                        id: home_tagline
                        text: "[b][i]Uncover the Best, Good Luck[/i][/b]"
                        font_name: "CursiveFont"
                        font_size: sp(25)
                        halign: "left"
                        valign: "middle"
                        text_size: self.width, None
                        size_hint_y: None
                        height: self.texture_size[1] + dp(6)
                        color: TEXT_MAIN

                    BoxLayout:
                        id: action_row
                        size_hint_y: None
                        height: dp(40)
                        spacing: dp(8)
                        padding: [dp(4), dp(2), dp(4), dp(2)]

                        AppButton:
                            text: "Refresh"
                            size_hint: None, None
                            width: dp(120)
                            height: dp(40)
                            on_release: root.refresh()

                        Widget:

                        AppButton:
                            text: "Filter"
                            size_hint: None, None
                            width: dp(120)
                            height: dp(40)
                            on_release: root.open_filters()

                Label:
                    text: "Loading..." if root.is_loading else "Posts"
                    size_hint_y: None
                    height: dp(24)
                    color: TEXT_MUTED

                ScrollView:
                    id: feed_scroll
                    size_hint_y: 1
                    do_scroll_x: False
                    bar_width: dp(6)

                    GridLayout:
                        id: list_container
                        cols: 1
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(8)

<FilterPopup>:
    # Use a full-screen modal overlay and draw our own rounded panel,
    # so the popup matches the Home screen card/panel theme.
    title: ""
    separator_height: 0
    size_hint: 1, 1
    auto_dismiss: True
    background: ""
    background_color: (0, 0, 0, 0)
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: PANEL_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
                Color:
                    rgba: (1, 1, 1, 0.12)
                Line:
                    width: 1.0
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                Label:
                    text: "[b]Filters[/b]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                Widget:
                AppButton:
                    text: "Close"
                    size_hint_x: None
                    width: dp(110)
                    color: (0.94, 0.27, 0.27, 1)
                    on_release: root.dismiss()

            Label:
                text: "[b]Search & Filters[/b]"
                size_hint_y: None
                height: dp(22)
                color: TEXT_MUTED

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "State (optional)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.state_value if root.home else "Any"
                            values: root.home.state_options if root.home else ["Any"]
                            on_text:
                                if root.home: root.home.state_value = self.text
                                if root.home: root.home.on_state_selected()
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "District (optional)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.district_value if root.home else "Any"
                            values: root.home.district_options if root.home else ["Any"]
                            disabled: (not root.home) or (root.home.state_value == "Any")
                            on_text:
                                if root.home: root.home.district_value = self.text
                                if root.home: root.home.on_district_selected()
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(260)
                        spacing: dp(6)
                        Label:
                            text: "Area (optional)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        TextInput:
                            hint_text: "Search areas ..."
                            text: root.home.area_search if root.home else ""
                            multiline: False
                            disabled: (not root.home) or (root.home.state_value == "Any") or (root.home.district_value == "Any")
                            on_text:
                                if root.home: root.home.area_search = self.text
                                if root.home: root.home.render_area_options(root.ids.area_options_container)
                            size_hint_y: None
                            height: dp(48)
                        ScrollView:
                            do_scroll_x: False
                            bar_width: dp(6)
                            size_hint_y: None
                            height: dp(150)
                            GridLayout:
                                id: area_options_container
                                cols: 1
                                size_hint_y: None
                                height: self.minimum_height
                                spacing: dp(6)
                        BoxLayout:
                            size_hint_y: None
                            height: dp(40)
                            spacing: dp(10)
                            AppButton:
                                text: "Clear Areas"
                                disabled: (not root.home) or (not root.home.selected_areas)
                                on_release:
                                    if root.home: root.home.clear_areas()
                                    if root.home: root.home.render_area_options(root.ids.area_options_container)
                                size_hint_x: None
                                width: dp(140)
                            Label:
                                text: ("Any" if (not root.home) or (not root.home.selected_areas) else (str(len(root.home.selected_areas)) + " selected"))
                                color: TEXT_MUTED
                                halign: "left"
                                valign: "middle"
                                text_size: self.size

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Nearby radius (km)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        TextInput:
                            text: root.home.radius_km if root.home else "20"
                            multiline: False
                            input_filter: "int"
                            on_text:
                                if root.home: root.home.radius_km = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(44)
                        spacing: dp(8)
                        Label:
                            text: root.home.gps_status if root.home else ""
                            color: TEXT_MUTED
                            halign: "left"
                            valign: "middle"
                            text_size: self.size
                    Widget:

                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(44)
                        spacing: dp(8)
                        AppButton:
                            text: "Enable GPS"
                            size_hint_x: None
                            width: dp(150)
                            on_release:
                                if root.home: root.home.enable_gps()
                        Label:
                            text: root.home.gps_msg if root.home else ""
                            color: TEXT_MUTED
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(96)
                        spacing: dp(4)
                        Label:
                            text: "Need category (materials / services / property)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(42)
                            halign: "left"
                            valign: "middle"
                            text_size: self.width, None
                        PrettySpinner:
                            text: root.home.need_category if root.home else "Any"
                            values: root.home.need_values if root.home else ["Any"]
                            on_text:
                                if root.home: root.home.need_category = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Post date"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.posted_within_days if root.home else "Any"
                            values: ["Any", "Today", "Last 7 days", "Last 30 days", "Last 90 days"]
                            on_text:
                                if root.home: root.home.posted_within_days = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Sort (by budget)"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.sort_budget if root.home else "Any (Newest)"
                            values: ["Any (Newest)", "Top (high to low)", "Bottom (low to high)"]
                            on_text:
                                if root.home: root.home.sort_budget = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Max budget"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        TextInput:
                            text: root.home.max_price if root.home else ""
                            multiline: False
                            input_filter: "int"
                            on_text:
                                if root.home: root.home.max_price = self.text
                            size_hint_y: None
                            height: dp(48)

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(82)
                        spacing: dp(4)
                        Label:
                            text: "Rent/Sale"
                            color: TEXT_MUTED
                            size_hint_y: None
                            height: dp(22)
                        PrettySpinner:
                            text: root.home.rent_sale if root.home else "Any"
                            values: ["Any", "Rent", "Sale"]
                            on_text:
                                if root.home: root.home.rent_sale = self.text
                            size_hint_y: None
                            height: dp(48)

            BoxLayout:
                size_hint_y: None
                height: dp(48)
                spacing: dp(10)
                AppButton:
                    text: "Apply filters"
                    on_release:
                        if root.home: root.home.refresh()
                        root.dismiss()

<MyPostsScreen>:
    name: "my_posts"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            MobileTopBar:

            WebPanel:
                size_hint_y: 1

                BoxLayout:
                    size_hint_y: None
                    height: dp(44)
                    spacing: dp(10)
                    Label:
                        text: "[b]My Posts[/b]"
                        font_size: sp(18)
                        halign: "left"
                        valign: "middle"
                        text_size: self.size
                    Widget:
                    AppButton:
                        text: "Refresh"
                        size_hint_x: None
                        width: dp(120)
                        on_release: root.refresh()
                    AppButton:
                        text: "Back"
                        size_hint_x: None
                        width: dp(100)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.back()

                Label:
                    text: "Loading..." if root.is_loading else ""
                    size_hint_y: None
                    height: dp(22)
                    color: TEXT_MUTED

                ScrollView:
                    do_scroll_x: False
                    bar_width: dp(6)
                    GridLayout:
                        id: my_posts_container
                        cols: 1
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(8)

<PropertyDetailScreen>:
    name: "property_detail"

    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: "vertical"
            size_hint: 1, 1

            MobileTopBar:

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    padding: dp(12)
                    spacing: dp(14)

                    # --------------------------------------------------
                    # POST CARD CONTAINER
                    # --------------------------------------------------
                    WebCard:
                        padding: dp(14)
                        spacing: dp(12)
                        size_hint_y: None
                        height: self.minimum_height

                        BoxLayout:
                            orientation: "vertical"
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(12)

                            # -----------------------------
                            # HEADER ROW (Avatar + Title)
                            # -----------------------------
                            BoxLayout:
                                size_hint_y: None
                                height: dp(60)
                                spacing: dp(12)

                                AvatarButton:
                                    size_hint: None, None
                                    size: dp(42), dp(42)
                                    pos_hint: {"center_y": 0.5}
                                    image_source: root.image_source
                                    fallback_text: (root.fallback_text if root.fallback_text else "ME")

                                BoxLayout:
                                    orientation: "vertical"
                                    size_hint_y: 1
                                    spacing: dp(2)

                                    Label:
                                        text: root.property_data.get("title","(loading...)")
                                        bold: True
                                        font_size: sp(17)
                                        halign: "left"
                                        valign: "middle"
                                        text_size: self.width, None
                                        size_hint_y: None
                                        height: self.texture_size[1] + dp(2)

                                    Label:
                                        text: "Ad #" + (str(root.property_data.get("adv_number") or root.property_data.get("ad_number") or root.property_id) if root.property_id else "") + " ‚Ä¢ " + (root.property_data.get("rent_sale") or "") + " ‚Ä¢ " + (root.property_data.get("property_type") or "")
                                        font_size: sp(12)
                                        color: TEXT_MUTED
                                        halign: "left"
                                        valign: "middle"
                                        text_size: self.width, None
                                        size_hint_y: None
                                        height: self.texture_size[1] + dp(2)

                                Widget:

                                AppButton:
                                    text: "Back"
                                    size_hint: None, 1
                                    width: dp(80)
                                    on_release: root.back()

                            # -----------------------------
                            # PRICE + LOCATION (CAPTION)
                            # -----------------------------
                            Label:
                                text: (root.property_data.get("price_display") or "") + " ‚Ä¢ " + (root.property_data.get("location_display") or "")
                                font_size: sp(14)
                                color: TEXT_MUTED
                                size_hint_y: None
                                text_size: self.width, None
                                height: self.texture_size[1] + dp(10)
                                halign: "left"

                            # -----------------------------
                            # IMAGE GRID (POST MEDIA)
                            # -----------------------------
                            GridLayout:
                                id: property_media_container
                                cols: 2
                                spacing: dp(8)
                                size_hint_y: None
                                height: self.minimum_height

                            # -----------------------------
                            # AMENITIES (POST TEXT)
                            # -----------------------------
                            Label:
                                text: "Amenities: " + (", ".join(root.property_data.get("amenities") or []) if root.property_data.get("amenities") else "‚Äî")
                                font_size: sp(13)
                                color: TEXT_MUTED
                                size_hint_y: None
                                text_size: self.width, None
                                height: self.texture_size[1] + dp(12)
                                halign: "left"

                            # -----------------------------
                            # ACTION BUTTONS (LIKE BAR STYLE)
                            # -----------------------------
                            BoxLayout:
                                size_hint_y: None
                                height: dp(48)
                                spacing: dp(12)

                                AppButton:
                                    text: "Contact"
                                    size_hint_x: 1
                                    on_release: root.unlock_contact()

                                AppButton:
                                    text: "üîóüì§"
                                    size_hint_x: 1
                                    on_release: root.share_current()


<OwnerAddPropertyScreen>:
    name: "owner_add_property"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)

            MobileTopBar:

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)
                WebPanel:
                    size_hint_x: None
                    width: min(root.width * 0.95, dp(980))
                    x: (root.width - self.width) / 2

                    Label:
                        text: "[b]Publish Ad[/b]  [font=EmojiFont]‚ûï[/font]"
                        font_size: sp(20)
                        size_hint_y: None
                        height: dp(32)
                    PrettySpinner:
                        id: state_spinner
                        text: "Select State"
                        values: root.state_values()
                        size_hint_y: None
                        height: dp(44)
                        on_text: root.on_state_changed()
                    PrettySpinner:
                        id: district_spinner
                        text: "Select District"
                        values: root.district_values()
                        size_hint_y: None
                        height: dp(44)
                        on_text: root.on_district_changed()
                    PrettySpinner:
                        id: area_spinner
                        text: "Select Area"
                        values: root.area_values()
                        size_hint_y: None
                        height: dp(44)
                    TextInput:
                        id: title_input
                        hint_text: "Title"
                        multiline: False
                        size_hint_y: None
                        height: dp(44)
                    PrettySpinner:
                        id: category_spinner
                        text: "Select Category"
                        values: root.category_values()
                        size_hint_y: None
                        height: dp(44)
                    PrettySpinner:
                        id: rent_sale_spinner
                        text: "Rent"
                        values: ["Rent", "Sale"]
                        size_hint_y: None
                        height: dp(44)
                    TextInput:
                        id: price_input
                        hint_text: "Price"
                        multiline: False
                        input_filter: "int"
                        size_hint_y: None
                        height: dp(44)
                    TextInput:
                        id: contact_phone_input
                        hint_text: "Contact phone"
                        multiline: False
                        size_hint_y: None
                        height: dp(44)
                    # Media upload (optional): max 10 images + 1 video
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(6)
                        Label:
                            text: "Upload media (optional)"
                            size_hint_y: None
                            height: dp(20)
                            color: 1, 1, 1, 0.85
                        AppButton:
                            text: "Choose Photos / Video"
                            size_hint_y: None
                            height: dp(44)
                            on_release: root.open_media_picker()
                        Label:
                            id: media_summary
                            text: ""
                            size_hint_y: None
                            height: dp(18)
                            color: 1, 1, 1, 0.75
                    AppButton:
                        id: submit_btn
                        text: "Submit (goes to admin review)"
                        size_hint_y: None
                        height: dp(50)
                        on_release: root.submit_listing()
                    AppButton:
                        text: "Back"
                        size_hint_y: None
                        height: dp(44)
                        color: (0.94, 0.27, 0.27, 1)
                        on_release: root.go_back()

