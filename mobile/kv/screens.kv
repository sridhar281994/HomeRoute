# Shiny purple theme (professional)
# NOTE: keep names stable to avoid touching every screen rule.
#:set BG_PURPLE (0.10, 0.04, 0.20, 1)               # deep purple base
#:set SHINE_PURPLE (0.70, 0.36, 0.98, 0.28)         # purple shine
#:set SHINE_WHITE (1, 1, 1, 0.09)

# Global typography (bold-ish via markup)
<Label>:
    markup: True
    bold: True
    color: 1, 1, 1, 1

<Button>:
    markup: True
    font_size: sp(16)
    bold: True

<AppButton@HoverButton>:
    markup: True
    font_size: sp(16)
    bold: True
    background_normal: ""
    background_down: ""
    background_disabled_normal: ""
    background_color: (0.22, 0.56, 0.95, 1)
    color: 1, 1, 1, 1
    # Use the existing `background_color` set by screens as the base color.
    # Hover/pressed is computed automatically (desktop hover; press everywhere).
    canvas.before:
        Color:
            rgba:
                (0, 0, 0, 0) if self.background_color[3] == 0 else (
                (
                max(0.0, self.background_color[0] - 0.10),
                max(0.0, self.background_color[1] - 0.10),
                max(0.0, self.background_color[2] - 0.10),
                self.background_color[3]
                ) if self.state == "down" else (
                min(1.0, self.background_color[0] + 0.08),
                min(1.0, self.background_color[1] + 0.08),
                min(1.0, self.background_color[2] + 0.08),
                self.background_color[3]
                ) if self.hovered else self.background_color
                )
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]
        Color:
            rgba: (1, 1, 1, 0) if self.background_color[3] == 0 else (1, 1, 1, 0.10)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 14]

<PrettySpinnerOption@SpinnerOption>:
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    color: 1, 1, 1, 1
    size_hint_y: None
    height: dp(44)
    canvas.before:
        Color:
            rgba: (0.20, 0.14, 0.30, 0.98) if self.state == "normal" else (0.30, 0.20, 0.42, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10]
        Color:
            rgba: (1, 1, 1, 0.10)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 10]

<PrettySpinner@Spinner>:
    option_cls: "PrettySpinnerOption"
    background_normal: ""
    background_down: ""
    background_color: (0, 0, 0, 0)
    color: 1, 1, 1, 1
    font_size: sp(16)
    padding: [dp(12), dp(10)]
    canvas.before:
        Color:
            rgba: (0.12, 0.16, 0.30, 0.86) if self.state == "normal" else (0.16, 0.20, 0.36, 0.95)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: (1, 1, 1, 0.10)
        Line:
            width: 1.0
            rounded_rectangle: [self.x, self.y, self.width, self.height, 12]

<SplashScreen>:
    name: "splash"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: (1.0, 0.72, 0.25, 0.16)
            Ellipse:
                size: self.width * 0.9, self.height * 0.6
                pos: self.center_x - self.width * 0.45, self.center_y - self.height * 0.25
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        Label:
            text: "[i][b]QuickRent[/b][/i]"
            font_size: sp(30)
            pos_hint: {"center_x": 0.5, "center_y": 0.55}

        Label:
            text: "Loading..."
            font_size: sp(16)
            color: 1, 1, 1, 0.7
            pos_hint: {"center_x": 0.5, "center_y": 0.45}

<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: (1.0, 0.72, 0.25, 0.14)
            Ellipse:
                size: self.width * 0.9, self.height * 0.6
                pos: self.center_x - self.width * 0.45, self.center_y - self.height * 0.25
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: 'vertical'
            size_hint: None, None
            # Responsive width/height
            width: min(root.width * 0.9, dp(600))
            height: min(self.minimum_height, root.height * 0.85)
            spacing: dp(20)
            padding: dp(20)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "[b]Find Your Perfect Match[/b]  üè†‚ú®"
                font_size: min(root.width * 0.08, sp(28))
                size_hint_y: None
                halign: "center"
                valign: "middle"
                text_size: (self.width, None)
                height: self.texture_size[1] + dp(20)

            AppButton:
                text: "Login"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.5, 1, 1)
                on_release: root.manager.current = 'login'

            AppButton:
                text: "Register"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.3, 0.8, 0.3, 1)
                on_release: root.manager.current = 'register'

        Label:
            text: "¬© 2025 SRTech Games"
            font_size: min(root.width * 0.035, sp(14))
            color: 1, 1, 1, 0.7
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5, "y": 0.05}

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False
            bar_width: 0

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                # ScrollView controls viewport size/pos when size_hint_x is set.
                # Using explicit width without disabling size_hint_x can cause repeated relayout loops.
                x: (root.width - self.width) / 2
                spacing: dp(15)
                padding: dp(20)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "[b]Secure Login[/b]  üîê"
                    font_size: sp(24)
                    halign: "center"
                    valign: "middle"
                    size_hint_y: None
                    text_size: (self.width, None)
                    height: self.texture_size[1] + dp(10)

                # Account Details Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.15, 0.3, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "Account Details"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: phone_input
                        hint_text: "Email / Username / Phone"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "Password"
                            password: login_password_toggle.state != "down"
                            multiline: False
                            font_size: sp(16)
                            size_hint: 1, 1
                            background_color: (0.95, 0.95, 0.95, 1)
                            foreground_color: (0.1, 0.1, 0.1, 1)
                            padding: [dp(10), dp(10), dp(40), dp(10)]
                        ToggleButton:
                            id: login_password_toggle
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {"right": 1, "center_y": 0.5}
                            text: ""
                            background_normal: ""
                            background_down: ""
                            background_color: (0,0,0,0)
                            color: (0.2, 0.2, 0.2, 1)
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    BoxLayout:
                        size_hint_y: None
                        height: dp(32)
                        spacing: dp(10)
                        CheckBox:
                            id: remember_me
                            size_hint: None, None
                            size: dp(32), dp(32)
                            active: root.remember_me
                            on_active: root.remember_me = self.active
                        Label:
                            text: "Keep me logged in"
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    BoxLayout:
                        size_hint_y: None
                        height: dp(32)
                        spacing: dp(10)
                        Label:
                            text: "[color=cccccc]Admin login uses OTP to[/color]  info@srtech.co.in"
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    AppButton:
                        text: "Request OTP"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.9, 0.6, 0.2, 1)
                        on_release: root.send_otp_to_user()

                # OTP Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    opacity: 1
                    disabled: False
                    canvas.before:
                        Color:
                            rgba: 0.2, 0.1, 0.25, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "OTP Verification"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: otp_input
                        hint_text: "Enter OTP"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    AppButton:
                        text: "Verify & Login"
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.3, 0.8, 0.4, 1)
                        on_release: root.verify_and_login()

                    AppButton:
                        text: "Forgot Password?"
                        size_hint_y: None
                        height: dp(40)
                        background_color: (0, 0, 0, 0)
                        on_release: root.open_forgot_password()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ForgotPasswordScreen>:
    name: "forgot_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: root.header_text
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: phone_input
                    hint_text: "Registered Phone/Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)

                AppButton:
                    text: "Send OTP"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.send_reset_otp()

                TextInput:
                    id: otp_input
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    disabled: not root.otp_stage_ready

                AppButton:
                    id: verify_btn
                    text: "Verify OTP"
                    size_hint_y: None
                    height: dp(48)
                    disabled: not root.otp_stage_ready
                    on_release: root.verify_otp_and_continue()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ResetPasswordScreen>:
    name: "reset_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Reset Password"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "New Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: confirm_password_input
                        hint_text: "Confirm Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: confirm_password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                AppButton:
                    text: "Save Password"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_new_password()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<SettingsScreen>:
    name: "profile"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "[b]Settings[/b]  ‚öôÔ∏è"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                # Profile image + role
                BoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(110)
                    spacing: dp(12)
                    padding: [0, dp(6), 0, dp(6)]
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.15, 0.3, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [14]

                    AsyncImage:
                        source: root.profile_image_url if root.profile_image_url else ""
                        allow_stretch: True
                        keep_ratio: True
                        size_hint_x: None
                        width: dp(96)

                    BoxLayout:
                        orientation: "vertical"
                        spacing: dp(8)

                        TextInput:
                            id: role_display
                            text: "Publish Ad" if root.role_value.lower() == "owner" else "Customer"
                            hint_text: "Role"
                            size_hint_y: None
                            height: dp(42)
                            multiline: False
                            disabled: True

                        AppButton:
                            text: "Change Photo"
                            size_hint_y: None
                            height: dp(42)
                            background_color: (0.2, 0.6, 0.9, 1)
                            on_release: root.open_image_picker()

                # Name update (server-backed)
                TextInput:
                    id: name_input
                    text: root.name_value
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Save Name  üíæ"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_name()

                # Current email/phone (read-only)
                TextInput:
                    id: phone_current
                    text: root.phone_value
                    hint_text: "Phone Number"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False
                    disabled: True

                TextInput:
                    id: email_current
                    text: root.email_value
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False
                    disabled: True

                # Change Email with OTP
                Label:
                    text: "[b]Change Email (OTP required)[/b]"
                    size_hint_y: None
                    height: dp(26)
                    color: 1, 1, 1, 0.9

                TextInput:
                    id: new_email_input
                    hint_text: "New Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Send Email OTP"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.9, 0.6, 0.2, 1)
                    on_release: root.request_email_otp()

                TextInput:
                    id: new_email_otp
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Verify & Update Email"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.verify_email_otp()

                # Change Phone with OTP
                Label:
                    text: "[b]Change Phone (OTP required)[/b]"
                    size_hint_y: None
                    height: dp(26)
                    color: 1, 1, 1, 0.9

                TextInput:
                    id: new_phone_input
                    hint_text: "New Phone"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Send Phone OTP"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.9, 0.6, 0.2, 1)
                    on_release: root.request_phone_otp()

                TextInput:
                    id: new_phone_otp
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                AppButton:
                    text: "Verify & Update Phone"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.verify_phone_otp()

                AppButton:
                    text: "Refresh Subscription Status"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.refresh_subscription()

                # Subscription quick actions
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.15, 0.3, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "Subscription"
                        size_hint_y: None
                        height: dp(20)
                        color: 1, 1, 1, 0.9

                    AppButton:
                        text: "Manage Subscription (Google Play)"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.2, 0.5, 0.9, 1)
                        on_release: root.manage_subscription()

                Label:
                    text: "Options"
                    size_hint_y: None
                    height: dp(30)
                    color: 1, 1, 1, 0.7

                AppButton:
                    text: "Subscription Status: " + root.subscription_status
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.5, 0.8, 1)
                    on_release: root.manage_subscription()

                AppButton:
                    text: "Change Password"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.5, 0.8, 1)
                    on_release:
                        root.manager.get_screen("forgot_password").open_from(source_screen="profile", title="Change Password")
                        root.manager.current = "forgot_password"

                AppButton:
                    text: "Logout"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.8, 0.2, 0.2, 1)
                    on_release: root.logout()

                AppButton:
                    text: "Delete account"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.75, 0.1, 0.1, 1)
                    on_release: root.delete_account()

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        ScrollView:
            size_hint: 0.94, 0.94
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False

            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.92, dp(600))
                spacing: dp(12)
                padding: dp(20)
                x: (root.width - self.width) / 2
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "[b]Create Account[/b]  ‚ú®"
                    font_size: sp(26)
                    size_hint_y: None
                    height: dp(50)

                TextInput:
                    id: name_input
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: phone_input
                    hint_text: "Phone Number"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: email_input
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)

                # Role selection: Owner / Customer
                BoxLayout:
                    size_hint_y: None
                    height: dp(48)
                    spacing: dp(10)
                    ToggleButton:
                        text: "[b]Publish Ad[/b]  üè¢"
                        group: "role_group"
                        on_state:
                            if self.state == "down": root.set_role("owner")
                    ToggleButton:
                        text: "[b]Customer[/b]  üßç"
                        group: "role_group"
                        state: "down"
                        on_state:
                            if self.state == "down": root.set_role("customer")

                # Hidden role holder used by python (simple + reliable)
                TextInput:
                    id: role_value
                    text: "customer"
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    disabled: True

                # Owner category (only for Owner)
                BoxLayout:
                    id: owner_category_box
                    orientation: "vertical"
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    disabled: True
                    spacing: dp(8)
                    Label:
                        text: "[b]Owner Category Selection[/b]  üèóÔ∏è"
                        size_hint_y: None
                        height: dp(24)
                        color: 1, 1, 1, 0.9
                    PrettySpinner:
                        id: owner_category_spinner
                        text: "Select Category"
                        values: root.owner_category_values()
                        size_hint_y: None
                        height: dp(48)

                PrettySpinner:
                    id: country_spinner
                    text: "Select State"
                    values: root.country_values()
                    size_hint_y: None
                    height: dp(48)
                    on_text: root.on_state_changed()

                PrettySpinner:
                    id: district_spinner
                    text: "Select District"
                    values: root.district_values()
                    size_hint_y: None
                    height: dp(48)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "Password"
                        password: True
                        size_hint: 1, 1
                        padding: [dp(10), dp(10), dp(40), dp(10)]
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                AppButton:
                    text: "[b]Register[/b]  ‚úÖ"
                    size_hint_y: None
                    height: dp(50)
                    background_color: (0.3, 0.7, 0.3, 1)
                    on_release: root.save_profile()

                AppButton:
                    text: "Login via Gmail"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.9, 0.6, 0.2, 1)
                    on_release: root.social_login("gmail")

                AppButton:
                    text: "Login via FB / Insta"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.4, 0.9, 1)
                    on_release: root.social_login("fb/insta")

                AppButton:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<HomeScreen>:
    name: "home"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
                source: root.bg_image
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                Label:
                    text: "[b]Home[/b]  üè°‚ú®  [color=cccccc]Discover amazing places[/color]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                AppButton:
                    text: "Profile  üë§"
                    size_hint_x: None
                    width: dp(90)
                    on_release: root.go_profile()
                    disabled: not root.is_logged_in
                    opacity: 1 if root.is_logged_in else 0
                    width: dp(90) if root.is_logged_in else 0

            GridLayout:
                cols: 2
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(8)

                TextInput:
                    hint_text: "Search (location, keyword)"
                    text: root.query
                    multiline: False
                    on_text: root.query = self.text
                    size_hint_y: None
                    height: dp(42)
                TextInput:
                    hint_text: "Max budget"
                    text: root.max_price
                    multiline: False
                    input_filter: "int"
                    on_text: root.max_price = self.text
                    size_hint_y: None
                    height: dp(42)

                PrettySpinner:
                    text: root.rent_sale
                    values: ["Any", "Rent", "Sale"]
                    on_text: root.rent_sale = self.text
                    size_hint_y: None
                    height: dp(42)
                PrettySpinner:
                    text: root.need_category
                    values: root.need_values
                    on_text: root.need_category = self.text
                    size_hint_y: None
                    height: dp(42)
                PrettySpinner:
                    text: root.property_type
                    values: ["Any", "apartment", "villa", "plot", "pg", "marriage_hall", "party_hall", "retailer", "steel_supplier", "brick_supplier", "sand_supplier", "msand_supplier", "cement_supplier", "interior_designer", "carpenter", "labor_contractor", "electrician", "plumber", "painter", "gardener", "cleaning_services"]
                    on_text: root.property_type = self.text
                    size_hint_y: None
                    height: dp(42)

            GridLayout:
                cols: 1 if root.width < dp(420) else 2
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(8)
                AppButton:
                    text: "Apply Filters"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.6, 0.9, 1)
                    on_release: root.refresh()
                AppButton:
                    text: "Publish Ad  üè¢"
                    size_hint_y: None
                    height: dp(44)
                    on_release: root.go_owner()
                    disabled: not root.is_logged_in
                    opacity: 1 if root.is_logged_in else 0
                    height: dp(44) if root.is_logged_in else 0

            Label:
                text: "Loading..." if root.is_loading else "Listings"
                size_hint_y: None
                height: dp(24)
                color: 1, 1, 1, 0.85

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)
                GridLayout:
                    id: list_container
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)

<PropertyDetailScreen>:
    name: "property_detail"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.95, 0.95
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(12)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                AppButton:
                    text: "Back"
                    size_hint_x: None
                    width: dp(90)
                    on_release: root.back()
                Label:
                    text: "Property Detail"
                    color: 1, 1, 1, 1

            Label:
                text: root.property_data.get("title","(loading...)")
                color: 1, 1, 1, 1
                font_size: sp(20)
                size_hint_y: None
                height: dp(32)

            Label:
                text: (root.property_data.get("price_display") or "") + " ‚Ä¢ " + (root.property_data.get("location_display") or "")
                color: 1, 1, 1, 0.9
                size_hint_y: None
                height: dp(24)

            Label:
                text: "Amenities: " + (", ".join(root.property_data.get("amenities") or []) if root.property_data.get("amenities") else "‚Äî")
                color: 1, 1, 1, 0.85

            AppButton:
                text: "Unlock Contact"
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.6, 0.9, 1)
                on_release: root.unlock_contact()

            AppButton:
                text: "Save / Share (demo)"
                size_hint_y: None
                height: dp(44)
                background_color: (0.3, 0.8, 0.3, 1)

<SubscriptionScreen>:
    name: "subscription"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height *  0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]

            Label:
                text: "Subscription"
                font_size: sp(24)
                size_hint_y: None
                height: dp(40)
                color: 1, 1, 1, 1

            Label:
                text: "Status: " + root.status_text
                color: 1, 1, 1, 0.9

            Label:
                text: "Payments are handled by Google Play Billing. This app only unlocks digital contact access after Google confirms an active subscription."
                color: 1, 1, 1, 0.8

            AppButton:
                text: "Aggressive ‚Äî ‚Çπ10"
                size_hint_y: None
                height: dp(48)
                background_color: (0.2, 0.6, 0.9, 1)
                on_release: root.simulate_google_play_success("aggressive_10")

            AppButton:
                text: "Instant ‚Äî ‚Çπ79"
                size_hint_y: None
                height: dp(48)
                background_color: (0.2, 0.6, 0.9, 1)
                on_release: root.simulate_google_play_success("instant_79")

            AppButton:
                text: "Smart ‚Äî ‚Çπ199 / month"
                size_hint_y: None
                height: dp(48)
                background_color: (0.2, 0.6, 0.9, 1)
                on_release: root.simulate_google_play_success("smart_monthly_199")

            AppButton:
                text: "Business ‚Äî ‚Çπ499 / 3 months"
                size_hint_y: None
                height: dp(48)
                background_color: (0.2, 0.6, 0.9, 1)
                on_release: root.simulate_google_play_success("business_quarterly_499")

            AppButton:
                text: "Back"
                size_hint_y: None
                height: dp(44)
                background_color: (0.7, 0.2, 0.2, 1)
                on_release: root.back()

<OwnerDashboardScreen>:
    name: "owner_dashboard"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
            Label:
                text: "[b]Publish Ad Dashboard[/b]  üè¢"
                font_size: sp(24)
                size_hint_y: None
                height: dp(40)
                color: 1, 1, 1, 1

            Label:
                text: ("[color=cccccc]Category:[/color] " + (root.owner_category if root.owner_category else "‚Äî"))
                color: 1, 1, 1, 0.9
                size_hint_y: None
                height: dp(26)

            Label:
                text: "[b]Owner Capabilities[/b]\\n‚Ä¢ Profile Management\\n‚Ä¢ Listing Management\\n‚Ä¢ Lead Management"
                color: 1, 1, 1, 0.85

            AppButton:
                text: "Create Listing  ‚ûï"
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.6, 0.9, 1)
                on_release: root.go_add()
            Label:
                text: "My Listings (demo)"
                color: 1, 1, 1, 0.85
            AppButton:
                text: "Back"
                size_hint_y: None
                height: dp(44)
                background_color: (0.7, 0.2, 0.2, 1)
                on_release: root.go_back()

<OwnerAddPropertyScreen>:
    name: "owner_add_property"
    FloatLayout:
        canvas.before:
            Color:
                rgba: BG_PURPLE
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: SHINE_PURPLE
            Ellipse:
                size: self.width * 1.25, self.height * 0.9
                pos: self.x - self.width * 0.25, self.top - self.height * 0.65
            Color:
                rgba: SHINE_WHITE
            Ellipse:
                size: self.width * 0.75, self.height * 0.5
                pos: self.right - self.width * 0.65, self.y - self.height * 0.12
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.9, 0.85
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(10)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [16]
            Label:
                text: "Publish Ad"
                font_size: sp(24)
                size_hint_y: None
                height: dp(40)
                color: 1, 1, 1, 1
            PrettySpinner:
                id: state_spinner
                text: "Select State"
                values: root.state_values()
                size_hint_y: None
                height: dp(44)
                on_text: root.on_state_changed()
            PrettySpinner:
                id: district_spinner
                text: "Select District"
                values: root.district_values()
                size_hint_y: None
                height: dp(44)
                on_text: root.on_district_changed()
            PrettySpinner:
                id: area_spinner
                text: "Select Area"
                values: root.area_values()
                size_hint_y: None
                height: dp(44)
            TextInput:
                id: title_input
                hint_text: "Title"
                multiline: False
                size_hint_y: None
                height: dp(44)
            PrettySpinner:
                id: category_spinner
                text: "property"
                values: ["materials", "services", "property"]
                size_hint_y: None
                height: dp(44)
            PrettySpinner:
                id: rent_sale_spinner
                text: "Rent"
                values: ["Rent", "Sale"]
                size_hint_y: None
                height: dp(44)
            TextInput:
                id: price_input
                hint_text: "Price"
                multiline: False
                input_filter: "int"
                size_hint_y: None
                height: dp(44)
            TextInput:
                id: contact_phone_input
                hint_text: "Contact phone"
                multiline: False
                size_hint_y: None
                height: dp(44)
            AppButton:
                text: "Submit (goes to admin review)"
                size_hint_y: None
                height: dp(50)
                background_color: (0.3, 0.8, 0.3, 1)
                on_release: root.submit_listing()
            AppButton:
                text: "Back"
                size_hint_y: None
                height: dp(44)
                background_color: (0.7, 0.2, 0.2, 1)
                on_release: root.go_back()

